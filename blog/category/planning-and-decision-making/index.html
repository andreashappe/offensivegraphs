
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://offensivegraphs.ai/blog/category/planning-and-decision-making/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>planning-and-decision-making - Offensive Graphs Playground</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XVEVXNXJ44"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XVEVXNXJ44",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XVEVXNXJ44",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#planning-and-decision-making" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Offensive Graphs Playground" class="md-header__button md-logo" aria-label="Offensive Graphs Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Offensive Graphs Playground
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              planning-and-decision-making
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/andreashappe/offensivegraphs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Offensive Graphs Playground" class="md-nav__button md-logo" aria-label="Offensive Graphs Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Offensive Graphs Playground
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/andreashappe/offensivegraphs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to the Playground
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/linux-priv-esc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Privilege Escalation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Documentation Series:
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Documentation Series:
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../series/initial-journey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security Agents with LangGraph
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../series/planning-and-decision-making/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning and Decision Making
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="planning-and-decision-making">planning-and-decision-making</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/3877188?v=4" alt="JÃ¼rgen Brandl">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-18 00:00:00">October 18, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../initial-journey/" class="md-meta__link">initial-journey</a>, 
              <a href="./" class="md-meta__link">planning-and-decision-making</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="the-journey-to-adding-a-scribe"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/">The Journey to Adding a Scribe</a></h2>
<p>As our plan-and-execute architecture evolved, we encountered a pivotal challenge: managing the ever-growing context within our Language Learning Models (LLMs). </p>
<p>Initially, our system thrived on a straightforward workflow, but as tasks became more complex, we need a way to efficiently handle and retain crucial information without overwhelming the LLMs (or us humans in the loop). This is where the <strong>Scribe</strong> node comes in, marking a significant milestone in our project's journey.</p>
<h4 id="why-we-added-a-scribe-node-to-take-notes"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#why-we-added-a-scribe-node-to-take-notes">Why We Added a Scribe Node to Take Notes</a></h4>
<p>In our initial setup, the planner and executor nodes worked together to formulate and execute plans based on a rather simple feedback loop. However, as the complexity of tasks increased, the need for a systematic way to capture and store and condense information became evident. </p>
<p>The <strong>Scribe</strong> node was introduced to address this very need. By automatically taking notes of every significant step and interaction, the Scribe ensures that valuable information is preserved throughout the execution process. This not only provides a clear high level transcript but also serves as a reliable reference for future planning and decision-making.</p>
<h4 id="reducing-context-size-for-llms-why-it-matters"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#reducing-context-size-for-llms-why-it-matters">Reducing Context Size for LLMs: Why It Matters</a></h4>
<p>LLMs, while powerful, have inherent limitations in terms of context length. Feeding them with excessively large contexts can lead to diminished performance, increased latency, and higher computational costs. By integrating the Scribe node, we strategically harvest essential information from the active context to a structured note. This reduction in context size ensures that the LLMs operate within their optimal parameters, maintaining efficiency and accuracy. Moreover, it prevents the model from getting bogged down by redundant or irrelevant information, allowing it to focus on what's truly important.</p>
<h4 id="step-by-step-guide-to-implementing-the-scribe-node"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#step-by-step-guide-to-implementing-the-scribe-node">Step-by-Step Guide to Implementing the Scribe Node</a></h4>
<p>Integrating the Scribe node into our existing architecture involves a series of methodical steps. Below is a comprehensive guide to help you navigate this integration seamlessly.</p>
<h5 id="1-understanding-the-scribes-role"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#1-understanding-the-scribes-role">1. <strong>Understanding the Scribe's Role</strong></a></h5>
<p>Before diving into the implementation, it's crucial to grasp the Scribe's responsibilities:</p>
<ul>
<li><strong>Note-Taking:</strong> Automatically record significant events, tool responses, and decisions made by the executor.</li>
<li><strong>Context Management:</strong> Store notes in a structured format to reduce the active context size for the LLMs.</li>
<li><strong>Facilitating Replanning:</strong> Provide the Replanner node with accurate and concise information to refine future plans.</li>
</ul>
<h5 id="2-implementing-the-scribe-function"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#2-implementing-the-scribe-function">2. <strong>Implementing the Scribe Function</strong></a></h5>
<p>The core of the Scribe node lies in its ability to process and store notes effectively. Here's how it's implemented in <code>executor_and_scribe.py</code>:</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_messages</span><span class="p">]</span>
</span></code></pre></div>
First we define a new State that includes a <code>notes</code> field. This is where the scribe will store our notes.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">def</span> <span class="nf">scribe</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="k">if</span> <span class="n">messages</span> <span class="o">:=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>        <span class="n">mission</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>        <span class="n">tool_call</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>        <span class="n">tool_response</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="n">notes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;The task is </span><span class="si">{</span><span class="n">mission</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot; You are tasked with taking notes of everything we learned about this linux system in a structured way.</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="s2">                                Keep your notes containing only hard facts in markdown and prune them regularly to only keep relevant facts.</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="s2">                                Try to stay within 25 Lines only write about things we know not about the task.</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="s2">                                Here are your current notes:</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="s2">                                </span><span class="si">{</span><span class="n">notes</span><span class="si">}</span><span class="s2"> </span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="s2">                                Here is a tool we called </span><span class="si">{</span><span class="n">tool_call</span><span class="si">}</span><span class="s2"> </span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="s2">                                which gave us this output </span><span class="si">{</span><span class="n">tool_response</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">}</span>
</span></code></pre></div>
<p>This function performs the following actions:</p>
<ul>
<li><strong>Extracting Information:</strong> Retrieves the mission statement (first prompt made), the last tool call, and the output that the tool call returned.</li>
<li><strong>Generating Notes:</strong> Utilizes the LLM to format and update the notes, ensuring they remain concise and relevant.</li>
<li><strong>Returning Updated State:</strong> Outputs the updated notes to be stored in the shared state.</li>
</ul>
<p>Let's break down the scribe prompt:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are tasked with taking notes of everything we learned about this linux system in a structured way.</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="s2">Keep your notes containing only hard facts in markdown and prune them regularly to only keep relevant facts.</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="s2">Try to stay within 25 Lines only write about things we know not about the task.</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="s2">Here are your current notes:</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="si">{</span><span class="n">notes</span><span class="si">}</span><span class="s2"> </span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="s2">Here is a tool we called </span><span class="si">{</span><span class="n">tool_call</span><span class="si">}</span><span class="s2"> </span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="s2">which gave us this output </span><span class="si">{</span><span class="n">tool_response</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This prompt is used to generate the notes. Telling it to stick with markdown and prune the notes to only keep relevant facts will keep the notes from getting too long and cluttered. It will also come in handy later when we present the notes to the user.</p>
<h5 id="3-wiring-the-scribe-into-the-workflow"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#3-wiring-the-scribe-into-the-workflow">3. <strong>Wiring the Scribe into the Workflow</strong></a></h5>
<p>To ensure the Scribe operates seamlessly within our graph, we need to integrate it as a node in the state graph. 
There are multiple ways to go about this but we decided to add the Scribe node as a node in the graph right after the tools node.</p>
<p>And within the graph builder:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;scribe&quot;</span><span class="p">,</span> <span class="n">scribe</span><span class="p">)</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;scribe&quot;</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;scribe&quot;</span><span class="p">,</span> <span class="s2">&quot;chatbot&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>This setup ensures that after a tool is executed, the Scribe processes the outcome before returning control to the executor.</p>
<h5 id="4-testing-the-scribe-integration"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#4-testing-the-scribe-integration">4. <strong>Testing the Scribe Integration</strong></a></h5>
<p>After implementing the Scribe node, it's essential to validate its functionality. Run the agent and monitor the notes panel to ensure that notes are being captured and updated correctly. Here's a snippet from the main execution flow:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>        <span class="nb">input</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>                <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>            <span class="p">]</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>        <span class="p">},</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>        <span class="n">config</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>            <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>        <span class="p">},</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>        <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>    <span class="p">)</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>    <span class="c1"># Use Live to update the layout dynamically</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>    <span class="k">with</span> <span class="n">Live</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>            <span class="k">if</span> <span class="s2">&quot;notes&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>                <span class="c1"># Update the notes content and the right panel</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>                <span class="n">notes_content</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>                <span class="n">layout</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">notes_content</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Notes&quot;</span><span class="p">))</span>
</span></code></pre></div>
<p>This block ensures that the notes are displayed in real-time, providing a clear overview of the information being captured.</p>
<p>Here is a video of the Scribe in action, you can reproduce it by running <code>python src/executor_and_scribe.py</code>:</p>
<video src="/screencast_offensive_graph.mp4" controls></video>

<h5 id="5-managing-shared-state-with-the-scribe"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#5-managing-shared-state-with-the-scribe">5. <strong>Managing Shared State with the Scribe</strong></a></h5>
<p>Let's move from our small example to a more complex one by integrating the Scribe into the <code>plan_and_execute</code> graph:
Our shared state (<code>PlanExecute</code>) must accommodate the notes taken by the Scribe. Here's the updated structure:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">class</span> <span class="nc">PlanExecute</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># the initial user-given objective</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>    <span class="n">plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>    <span class="n">past_steps</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># response from the agent to the user</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># structured notes from the Scribe</span>
</span></code></pre></div>
<p>By including the <code>notes</code> field, all nodes within the graph can access and update the notes as required.</p>
<h5 id="6-enhancing-the-replanner-with-scribe-notes"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#6-enhancing-the-replanner-with-scribe-notes">6. <strong>Enhancing the Replanner with Scribe Notes</strong></a></h5>
<p>The Replanner leverages the notes to refine future plans. Here's an excerpt showcasing this integration:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">replanner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="sd">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="sd">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="sd">Your objective was this:</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="sd">{input}</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="sd">Your original plan was this:</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="sd">{plan}</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="sd">You have currently done the follow steps:</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="sd">{past_steps}</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="sd">Your notes are:</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="sd">{notes}</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="sd">Update your plan accordingly. If no more steps are needed and you can return to the user, then respond with that. Otherwise, fill out the plan. Only add steps to the plan that still NEED to be done. Do not return previously done steps as part of the plan.</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="sd">If you were not able to complete the task, stop after 15 planning steps and give a summary to the user.</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="p">)</span>
</span></code></pre></div>
<p>Notice the inclusion of <code>{notes}</code> in the prompt, allowing the Replanner to make informed decisions based on the accumulated notes.</p>
<h4 id="conclusion"><a class="toclink" href="../../2024/10/18/the-journey-to-adding-a-scribe/#conclusion">Conclusion</a></h4>
<p>Let's take a look at the notes after we finished our run:</p>
<p><div class="language-markdown highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>    # Linux System Notes
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    ## User Information
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Current user: <span class="sb">`lowpriv`</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>User password: <span class="sb">`trustno1`</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>User privilege: Low-privilege
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>User ID: <span class="sb">`uid=1001(lowpriv)`</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Group ID: <span class="sb">`gid=1001(lowpriv)`</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Groups: <span class="sb">`1001(lowpriv)`</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>    ## Authentication
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>SSH login successful with provided credentials (<span class="sb">`lowpriv`</span> / <span class="sb">`trustno1`</span>).
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>User <span class="sb">`lowpriv`</span> is not root.
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    ## Privilege Escalation
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Successful privilege escalation to root using SUID binary <span class="sb">`/usr/bin/python3.11`</span>.
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Command used: <span class="sb">`python3.11 -c &#39;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#39;`</span>.
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>    ## SUID Binaries
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Identified SUID binaries:
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/python3.11`</span> (used for privilege escalation)
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/newgrp`</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/chfn`</span>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/gpasswd`</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/chsh`</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/passwd`</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/sudo`</span>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/mount`</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/su`</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/find`</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/bin/umount`</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/lib/openssh/ssh-keysign`</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span><span class="sb">`/usr/lib/dbus-1.0/dbus-daemon-launch-helper`</span>
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a>    ## Next Steps
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Verify system access and capabilities as root.
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a><span class="w">    </span><span class="k">-</span><span class="w"> </span>Document any additional findings or configurations.
</span></code></pre></div>
The Scribe agent was able to reduce the vast output of our tool calls into a concise fact sheet. Depending on the recursion-limit we set to our executor this can be the result of multiple thousend lines of command line output.</p>
<p>This structured approach to note-taking paves the way for more sophisticated and efficient planning mechanisms, setting the stage for future advancements in our journey to multi-step attack planning. As we continue to refine and expand our system, the Scribe will undoubtedly play a pivotal role in ensuring that our agents remain informed, agile, and capable of tackling increasingly complex tasks.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/20667?v=4" alt="Andreas Happe">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-14 00:00:00">October 14, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../initial-journey/" class="md-meta__link">initial-journey</a>, 
              <a href="./" class="md-meta__link">planning-and-decision-making</a></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="adding-plan-and-execute-planner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/">Adding Plan-and-Execute Planner</a></h2>
<p>All sources can be found in <a href="https://github.com/andreashappe/offensivegraphs/tree/dbe5ae76d044e6dc876dcb86029f853a30bac565">our github history</a>.</p>
<p>When using LLMs for complex tasks like hacking, a common problem is that they become hyper-focused upon a single attack vector and ignore all others. They go down a "depth-first" rabbit hole and never leave it. This was experienced by <a href="https://arxiv.org/abs/2310.11409">me</a> and <a href="https://arxiv.org/abs/2308.06782">others</a>.</p>
<h3 id="plan-and-execute-pattern"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#plan-and-execute-pattern">Plan-and-Execute Pattern</a></h3>
<p>One potential solution is the <a href="https://arxiv.org/abs/2305.04091">'plan-and-solve'-pattern</a> (often also named <a href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">'plan-and-execute'-pattern</a>). in this strategy, one LLM (the <code>planner</code>) is given the task of creating a high-level task plan based upon the user-given objective. The task plan is processed by another LLM module (the <code>agent</code> or <code>executor</code>). Basically, the next step from the task plan is taken and forwarded to the executer to solve within in a limited number of steps or time.</p>
<p>The executor's result is passed back to another LLM module (the <code>replan</code> module) that updates the task plan with the new findings and, if the overall objective has not been achieved already, calls the executor agent with the next task step. The <code>replan</code> and <code>plan</code> LLM modules are typically very similar to each other, as we will see within our code example later.</p>
<p>An advanced version is Gelei's <code>Penetration Task Tree</code> <a href="https://arxiv.org/abs/2308.06782">detailed in the pentestGPT paper</a>.</p>
<p>Let's build a simple plan-and-execute prototype, highly influenced by the <a href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">plan-and-execute langgraph example</a>.</p>
<h3 id="the-high-level-graph"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#the-high-level-graph">The High-Level Graph</a></h3>
<p>One benefit of using this blog for documenting our journey is that we can do the explanation in a non-linear (regarding the source code) order.</p>
<p>Let's start with the overall graph as defined through <code>create_plan_and_execute_graph</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Overall graph</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-24-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-24-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-24-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-24-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-24-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-24-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-24-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-24-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-24-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-24-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-24-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-24-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-24-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-24-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-24-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-24-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-24-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-24-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-24-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-24-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-24-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-24-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-24-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-24-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-24-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-24-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-24-100">100</a></span>
<span class="normal"><a href="#__codelineno-24-101">101</a></span>
<span class="normal"><a href="#__codelineno-24-102">102</a></span>
<span class="normal"><a href="#__codelineno-24-103">103</a></span>
<span class="normal"><a href="#__codelineno-24-104">104</a></span>
<span class="normal"><a href="#__codelineno-24-105">105</a></span>
<span class="normal"><a href="#__codelineno-24-106">106</a></span>
<span class="normal"><a href="#__codelineno-24-107">107</a></span>
<span class="normal"><a href="#__codelineno-24-108">108</a></span>
<span class="normal"><a href="#__codelineno-24-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73"></a><span class="k">def</span> <span class="nf">create_plan_and_execute_graph</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">):</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74"></a>
</span><span id="__span-24-75"><a id="__codelineno-24-75" name="__codelineno-24-75"></a>    <span class="k">def</span> <span class="nf">should_end</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-24-76"><a id="__codelineno-24-76" name="__codelineno-24-76"></a>        <span class="k">if</span> <span class="s2">&quot;response&quot;</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]:</span>
</span><span id="__span-24-77"><a id="__codelineno-24-77" name="__codelineno-24-77"></a>            <span class="k">return</span> <span class="n">END</span>
</span><span id="__span-24-78"><a id="__codelineno-24-78" name="__codelineno-24-78"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-79"><a id="__codelineno-24-79" name="__codelineno-24-79"></a>            <span class="k">return</span> <span class="s2">&quot;agent&quot;</span>
</span><span id="__span-24-80"><a id="__codelineno-24-80" name="__codelineno-24-80"></a>
</span><span id="__span-24-81"><a id="__codelineno-24-81" name="__codelineno-24-81"></a>    <span class="k">def</span> <span class="nf">plan_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-24-82"><a id="__codelineno-24-82" name="__codelineno-24-82"></a>        <span class="n">planner</span> <span class="o">=</span> <span class="n">planner_prompt</span> <span class="o">|</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Plan</span><span class="p">)</span>
</span><span id="__span-24-83"><a id="__codelineno-24-83" name="__codelineno-24-83"></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">])]})</span>
</span><span id="__span-24-84"><a id="__codelineno-24-84" name="__codelineno-24-84"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
</span><span id="__span-24-85"><a id="__codelineno-24-85" name="__codelineno-24-85"></a>
</span><span id="__span-24-86"><a id="__codelineno-24-86" name="__codelineno-24-86"></a>    <span class="k">def</span> <span class="nf">replan_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-24-87"><a id="__codelineno-24-87" name="__codelineno-24-87"></a>        <span class="n">replanner</span> <span class="o">=</span> <span class="n">replanner_prompt</span> <span class="o">|</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Act</span><span class="p">)</span>
</span><span id="__span-24-88"><a id="__codelineno-24-88" name="__codelineno-24-88"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">replanner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-24-89"><a id="__codelineno-24-89" name="__codelineno-24-89"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
</span><span id="__span-24-90"><a id="__codelineno-24-90" name="__codelineno-24-90"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">response</span><span class="p">}</span>
</span><span id="__span-24-91"><a id="__codelineno-24-91" name="__codelineno-24-91"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-92"><a id="__codelineno-24-92" name="__codelineno-24-92"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
</span><span id="__span-24-93"><a id="__codelineno-24-93" name="__codelineno-24-93"></a>
</span><span id="__span-24-94"><a id="__codelineno-24-94" name="__codelineno-24-94"></a>    <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">PlanExecute</span><span class="p">)</span>
</span><span id="__span-24-95"><a id="__codelineno-24-95" name="__codelineno-24-95"></a>
</span><span id="__span-24-96"><a id="__codelineno-24-96" name="__codelineno-24-96"></a>    <span class="c1"># Add the nodes</span>
</span><span id="__span-24-97"><a id="__codelineno-24-97" name="__codelineno-24-97"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="n">plan_step</span><span class="p">)</span>
</span><span id="__span-24-98"><a id="__codelineno-24-98" name="__codelineno-24-98"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">)</span>
</span><span id="__span-24-99"><a id="__codelineno-24-99" name="__codelineno-24-99"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;replan&quot;</span><span class="p">,</span> <span class="n">replan_step</span><span class="p">)</span>
</span><span id="__span-24-100"><a id="__codelineno-24-100" name="__codelineno-24-100"></a>
</span><span id="__span-24-101"><a id="__codelineno-24-101" name="__codelineno-24-101"></a>    <span class="c1"># set the start node</span>
</span><span id="__span-24-102"><a id="__codelineno-24-102" name="__codelineno-24-102"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;planner&quot;</span><span class="p">)</span>
</span><span id="__span-24-103"><a id="__codelineno-24-103" name="__codelineno-24-103"></a>
</span><span id="__span-24-104"><a id="__codelineno-24-104" name="__codelineno-24-104"></a>    <span class="c1"># configure links between nodes</span>
</span><span id="__span-24-105"><a id="__codelineno-24-105" name="__codelineno-24-105"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>
</span><span id="__span-24-106"><a id="__codelineno-24-106" name="__codelineno-24-106"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;replan&quot;</span><span class="p">)</span>
</span><span id="__span-24-107"><a id="__codelineno-24-107" name="__codelineno-24-107"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;replan&quot;</span><span class="p">,</span> <span class="n">should_end</span><span class="p">)</span>
</span><span id="__span-24-108"><a id="__codelineno-24-108" name="__codelineno-24-108"></a>
</span><span id="__span-24-109"><a id="__codelineno-24-109" name="__codelineno-24-109"></a>    <span class="k">return</span> <span class="n">workflow</span>
</span></code></pre></div></td></tr></table></div>
<p>The overall flow is defined in line 94 and following. You can see the mentioned nodes: <code>planner</code>, <code>agent</code> (the executor)and <code>replan</code> and a graph that follows the outline described in the introduction.</p>
<p><code>should_end</code> (line 75) is the exit-condition: if the replanner is not calling the sub-agent (<code>agent</code>), it can only send a message to the initial human (within the field <code>response</code>). The function detects this response and subsequently exits the graph.</p>
<h4 id="shared-state"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#shared-state">Shared State</a></h4>
<p>The shared state describes the data that is stored within the graph, i.e., the data that all our nodes will have access to. It is defined through <code>PlanExecute</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Shared State</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-45">45</a></span>
<span class="normal"><a href="#__codelineno-25-46">46</a></span>
<span class="normal"><a href="#__codelineno-25-47">47</a></span>
<span class="normal"><a href="#__codelineno-25-48">48</a></span>
<span class="normal"><a href="#__codelineno-25-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45"></a><span class="k">class</span> <span class="nc">PlanExecute</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46"></a>    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># the initial user-given objective</span>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47"></a>    <span class="n">plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48"></a>    <span class="n">past_steps</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># response from the agent to the user</span>
</span></code></pre></div></td></tr></table></div>
<p>We store the following data:</p>
<ul>
<li><code>input</code>: the initially given user question/objective, i.e., "I want to become root"</li>
<li><code>response</code>: the final answer given by our LLM to the user question</li>
<li><code>plan</code>: a (string) list of planning steps that need to be performed to hopefully solve the user question</li>
<li><code>past_steps</code>: a list of already performed planning steps. In our implementation this also contains a short summary (given by the execution agent) about the operations performed by the execution agent (stored for each past step).</li>
</ul>
<h3 id="graph-nodesactions"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#graph-nodesactions">Graph Nodes/Actions</a></h3>
<p><code>planner</code> and <code>replan</code> are implemented through <code>plan_step</code> and <code>replan_step</code> respectively. The <code>agent</code> (or executor) is passed in as <code>execute_step</code> function parameter as this allows us to easily reuse the generic plan-and-execute graph for different use-cases.</p>
<h4 id="planner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#planner">Planner</a></h4>
<p>Let's look at the planner next. It is implemented as a LLM call using <code>llm.with_structured_output</code> to allow for automatic output parsing into the <code>Plan</code> data structure:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Plan data structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-52">52</a></span>
<span class="normal"><a href="#__codelineno-26-53">53</a></span>
<span class="normal"><a href="#__codelineno-26-54">54</a></span>
<span class="normal"><a href="#__codelineno-26-55">55</a></span>
<span class="normal"><a href="#__codelineno-26-56">56</a></span>
<span class="normal"><a href="#__codelineno-26-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52"></a><span class="k">class</span> <span class="nc">Plan</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Plan to follow in future&quot;&quot;&quot;</span>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54"></a>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55"></a>    <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;different steps to follow, should be in sorted order&quot;</span>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The output is thus a simple string list with the different future planning steps. The LLM prompt itself is defined as:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Planner Prompt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="n">planner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13"></a>    <span class="p">[</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14"></a>        <span class="p">(</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15"></a>            <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="sd">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="sd">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19"></a>        <span class="p">),</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20"></a>        <span class="p">(</span><span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{messages}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21"></a>    <span class="p">]</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This is rather generic. The initial user question will be passed in as first message within <code>{messages}</code> and that's more or less it.</p>
<h4 id="replanner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#replanner">Replanner</a></h4>
<p>The result of the replanner node action/step wil be following:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Replanner data structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-59">59</a></span>
<span class="normal"><a href="#__codelineno-28-60">60</a></span>
<span class="normal"><a href="#__codelineno-28-61">61</a></span>
<span class="normal"><a href="#__codelineno-28-62">62</a></span>
<span class="normal"><a href="#__codelineno-28-63">63</a></span>
<span class="normal"><a href="#__codelineno-28-64">64</a></span>
<span class="normal"><a href="#__codelineno-28-65">65</a></span>
<span class="normal"><a href="#__codelineno-28-66">66</a></span>
<span class="normal"><a href="#__codelineno-28-67">67</a></span>
<span class="normal"><a href="#__codelineno-28-68">68</a></span>
<span class="normal"><a href="#__codelineno-28-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-59"><a id="__codelineno-28-59" name="__codelineno-28-59"></a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-28-60"><a id="__codelineno-28-60" name="__codelineno-28-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Response to user.&quot;&quot;&quot;</span>
</span><span id="__span-28-61"><a id="__codelineno-28-61" name="__codelineno-28-61"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-28-62"><a id="__codelineno-28-62" name="__codelineno-28-62"></a>
</span><span id="__span-28-63"><a id="__codelineno-28-63" name="__codelineno-28-63"></a><span class="k">class</span> <span class="nc">Act</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-28-64"><a id="__codelineno-28-64" name="__codelineno-28-64"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Action to perform.&quot;&quot;&quot;</span>
</span><span id="__span-28-65"><a id="__codelineno-28-65" name="__codelineno-28-65"></a>
</span><span id="__span-28-66"><a id="__codelineno-28-66" name="__codelineno-28-66"></a>    <span class="n">action</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Response</span><span class="p">,</span> <span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-28-67"><a id="__codelineno-28-67" name="__codelineno-28-67"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Action to perform. If you want to respond to user, use Response. &quot;</span>
</span><span id="__span-28-68"><a id="__codelineno-28-68" name="__codelineno-28-68"></a>        <span class="s2">&quot;If you need to further use tools to get the answer, use Plan.&quot;</span>
</span><span id="__span-28-69"><a id="__codelineno-28-69" name="__codelineno-28-69"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>So it's either a user <code>Response</code> (consisting of a string) signalling that we have finished, or an updated <code>Plan</code> (the previously mentioned list of strings) which the <code>executor</code> will act upon next.</p>
<p>Let's look at the prompt:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Replanner Prompt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span>
<span class="normal"><a href="#__codelineno-29-39">39</a></span>
<span class="normal"><a href="#__codelineno-29-40">40</a></span>
<span class="normal"><a href="#__codelineno-29-41">41</a></span>
<span class="normal"><a href="#__codelineno-29-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24"></a><span class="n">replanner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26"></a><span class="sd">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27"></a><span class="sd">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28"></a>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29"></a><span class="sd">Your objective was this:</span>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30"></a><span class="sd">{input}</span>
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31"></a>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32"></a><span class="sd">Your original plan was this:</span>
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33"></a><span class="sd">{plan}</span>
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34"></a>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35"></a><span class="sd">You have currently done the follow steps:</span>
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36"></a><span class="sd">{past_steps}</span>
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37"></a>
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38"></a><span class="sd">Update your plan accordingly. If no more steps are needed and you can return to the user, then respond with that. Otherwise, fill out the plan. Only add steps to the plan that still NEED to be done. Do not return previously done steps as part of the plan.</span>
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39"></a>
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40"></a><span class="sd">If you were not able to complete the task, stop after 15 planning steps and give a summary to the user.</span>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The prompt's input is the initial objective (<code>input</code>), the current plan containing all future high-level task steps (<code>plan</code>), and a list of previously executed planning steps (<code>plan_steps</code>). In our implementation, each <code>plan_step</code> also contains a LLM-derived summary of the actions performed by the <code>executor</code> while trying to solve the planning step as well as it's results. This should help the <code>replan</code> agent to better update subsequent plans.</p>
<p>We also tell the LLM to stop after 15 high-level task steps and give a final summary to the user. If the objective has been solved before, the LLM will detect this too and auto-magically stop execution.</p>
<h4 id="agentexecutor"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#agentexecutor">Agent/Executor</a></h4>
<p>The <code>executor</code> node/function is passed into our generic path as a callback function. This allows to easily modify our generic graph to solve different objectives with their respective specialized executor agents.</p>
<p>Let's start with our simple implementation:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">plan_and_execute.py: Executor Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span>
<span class="normal"><a href="#__codelineno-30-37">37</a></span>
<span class="normal"><a href="#__codelineno-30-38">38</a></span>
<span class="normal"><a href="#__codelineno-30-39">39</a></span>
<span class="normal"><a href="#__codelineno-30-40">40</a></span>
<span class="normal"><a href="#__codelineno-30-41">41</a></span>
<span class="normal"><a href="#__codelineno-30-42">42</a></span>
<span class="normal"><a href="#__codelineno-30-43">43</a></span>
<span class="normal"><a href="#__codelineno-30-44">44</a></span>
<span class="normal"><a href="#__codelineno-30-45">45</a></span>
<span class="normal"><a href="#__codelineno-30-46">46</a></span>
<span class="normal"><a href="#__codelineno-30-47">47</a></span>
<span class="normal"><a href="#__codelineno-30-48">48</a></span>
<span class="normal"><a href="#__codelineno-30-49">49</a></span>
<span class="normal"><a href="#__codelineno-30-50">50</a></span>
<span class="normal"><a href="#__codelineno-30-51">51</a></span>
<span class="normal"><a href="#__codelineno-30-52">52</a></span>
<span class="normal"><a href="#__codelineno-30-53">53</a></span>
<span class="normal"><a href="#__codelineno-30-54">54</a></span>
<span class="normal"><a href="#__codelineno-30-55">55</a></span>
<span class="normal"><a href="#__codelineno-30-56">56</a></span>
<span class="normal"><a href="#__codelineno-30-57">57</a></span>
<span class="normal"><a href="#__codelineno-30-58">58</a></span>
<span class="normal"><a href="#__codelineno-30-59">59</a></span>
<span class="normal"><a href="#__codelineno-30-60">60</a></span>
<span class="normal"><a href="#__codelineno-30-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29"></a><span class="n">llm2</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-30-30"><a id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">SshExecuteTool</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">SshTestCredentialsTool</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span>
</span><span id="__span-30-31"><a id="__codelineno-30-31" name="__codelineno-30-31"></a><span class="n">llm2_with_tools</span> <span class="o">=</span> <span class="n">llm2</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="__span-30-32"><a id="__codelineno-30-32" name="__codelineno-30-32"></a>
</span><span id="__span-30-33"><a id="__codelineno-30-33" name="__codelineno-30-33"></a><span class="k">def</span> <span class="nf">execute_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-30-34"><a id="__codelineno-30-34" name="__codelineno-30-34"></a>    <span class="n">plan</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span>
</span><span id="__span-30-35"><a id="__codelineno-30-35" name="__codelineno-30-35"></a>    <span class="n">task</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-30-36"><a id="__codelineno-30-36" name="__codelineno-30-36"></a>
</span><span id="__span-30-37"><a id="__codelineno-30-37" name="__codelineno-30-37"></a>    <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-30-38"><a id="__codelineno-30-38" name="__codelineno-30-38"></a><span class="s2">    You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-30-39"><a id="__codelineno-30-39" name="__codelineno-30-39"></a>
</span><span id="__span-30-40"><a id="__codelineno-30-40" name="__codelineno-30-40"></a><span class="s2">    To achieve this, focus upon </span><span class="si">{task}</span>
</span><span id="__span-30-41"><a id="__codelineno-30-41" name="__codelineno-30-41"></a>
</span><span id="__span-30-42"><a id="__codelineno-30-42" name="__codelineno-30-42"></a><span class="s2">    Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message. Stop after 10 executions. If not successful until then, give a summary of gathered facts.</span>
</span><span id="__span-30-43"><a id="__codelineno-30-43" name="__codelineno-30-43"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">,</span><span class="n">task</span><span class="o">=</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="__span-30-44"><a id="__codelineno-30-44" name="__codelineno-30-44"></a>
</span><span id="__span-30-45"><a id="__codelineno-30-45" name="__codelineno-30-45"></a>    <span class="c1"># create our simple graph</span>
</span><span id="__span-30-46"><a id="__codelineno-30-46" name="__codelineno-30-46"></a>    <span class="n">graph_builder</span> <span class="o">=</span> <span class="n">create_chat_tool_agent_graph</span><span class="p">(</span><span class="n">llm2_with_tools</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
</span><span id="__span-30-47"><a id="__codelineno-30-47" name="__codelineno-30-47"></a>    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span id="__span-30-48"><a id="__codelineno-30-48" name="__codelineno-30-48"></a>
</span><span id="__span-30-49"><a id="__codelineno-30-49" name="__codelineno-30-49"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-30-50"><a id="__codelineno-30-50" name="__codelineno-30-50"></a>        <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">)]},</span>
</span><span id="__span-30-51"><a id="__codelineno-30-51" name="__codelineno-30-51"></a>        <span class="n">stream_mode</span><span class="o">=</span><span class="s1">&#39;values&#39;</span>
</span><span id="__span-30-52"><a id="__codelineno-30-52" name="__codelineno-30-52"></a>    <span class="p">)</span>
</span><span id="__span-30-53"><a id="__codelineno-30-53" name="__codelineno-30-53"></a>
</span><span id="__span-30-54"><a id="__codelineno-30-54" name="__codelineno-30-54"></a>    <span class="n">agent_response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-30-55"><a id="__codelineno-30-55" name="__codelineno-30-55"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-30-56"><a id="__codelineno-30-56" name="__codelineno-30-56"></a>        <span class="n">print_event</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="__span-30-57"><a id="__codelineno-30-57" name="__codelineno-30-57"></a>        <span class="n">agent_response</span> <span class="o">=</span> <span class="n">event</span>
</span><span id="__span-30-58"><a id="__codelineno-30-58" name="__codelineno-30-58"></a>
</span><span id="__span-30-59"><a id="__codelineno-30-59" name="__codelineno-30-59"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-30-60"><a id="__codelineno-30-60" name="__codelineno-30-60"></a>        <span class="s2">&quot;past_steps&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">task</span><span class="p">,</span> <span class="n">agent_response</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">)],</span>
</span><span id="__span-30-61"><a id="__codelineno-30-61" name="__codelineno-30-61"></a>    <span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>We are reusing our <a href="../../2024/10/10/first-steps-and-initial-version/">initial simple agent</a> as executor on line 46. On lines 29-31 we are creating a new connection to OpenAI and configure some SSH-based tools (as mentioned in the original post) for our executor agent. This fully separated the LLM connection, graph history and supported tools from the LLM-configuration used by the plan-and-execute graph and would allow for using different LLMs for the <code>planner</code> and <code>executor</code> respectively.</p>
<p>Starting on line 49 , we execute our sub-agent and output its steps before returning the final step on line 59 as <code>past_steps</code>. This will append our agent's output (which includes a generated summary of its results) to <code>past_steps</code> within our shared state (which will subsequently be used by the <code>replanner</code> agent to refine future planning steps).</p>
<h3 id="wiring-it-up-and-starting-it"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#wiring-it-up-and-starting-it">Wiring it up and starting it</a></h3>
<p>The only thins left is to wire up everything, provide the initial template and output the occurring events (to see what our LLM agent is doing):</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">plan_and_execute.py: Starting our Agent</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-64">64</a></span>
<span class="normal"><a href="#__codelineno-31-65">65</a></span>
<span class="normal"><a href="#__codelineno-31-66">66</a></span>
<span class="normal"><a href="#__codelineno-31-67">67</a></span>
<span class="normal"><a href="#__codelineno-31-68">68</a></span>
<span class="normal"><a href="#__codelineno-31-69">69</a></span>
<span class="normal"><a href="#__codelineno-31-70">70</a></span>
<span class="normal"><a href="#__codelineno-31-71">71</a></span>
<span class="normal"><a href="#__codelineno-31-72">72</a></span>
<span class="normal"><a href="#__codelineno-31-73">73</a></span>
<span class="normal"><a href="#__codelineno-31-74">74</a></span>
<span class="normal"><a href="#__codelineno-31-75">75</a></span>
<span class="normal"><a href="#__codelineno-31-76">76</a></span>
<span class="normal"><a href="#__codelineno-31-77">77</a></span>
<span class="normal"><a href="#__codelineno-31-78">78</a></span>
<span class="normal"><a href="#__codelineno-31-79">79</a></span>
<span class="normal"><a href="#__codelineno-31-80">80</a></span>
<span class="normal"><a href="#__codelineno-31-81">81</a></span>
<span class="normal"><a href="#__codelineno-31-82">82</a></span>
<span class="normal"><a href="#__codelineno-31-83">83</a></span>
<span class="normal"><a href="#__codelineno-31-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-64"><a id="__codelineno-31-64" name="__codelineno-31-64"></a><span class="n">workflow</span> <span class="o">=</span> <span class="n">create_plan_and_execute_graph</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">)</span>
</span><span id="__span-31-65"><a id="__codelineno-31-65" name="__codelineno-31-65"></a><span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span id="__span-31-66"><a id="__codelineno-31-66" name="__codelineno-31-66"></a><span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">xray</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">draw_ascii</span><span class="p">())</span>
</span><span id="__span-31-67"><a id="__codelineno-31-67" name="__codelineno-31-67"></a>
</span><span id="__span-31-68"><a id="__codelineno-31-68" name="__codelineno-31-68"></a><span class="c1"># now start our agent and give it our initial prompt (&#39;get root&#39;)</span>
</span><span id="__span-31-69"><a id="__codelineno-31-69" name="__codelineno-31-69"></a><span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-31-70"><a id="__codelineno-31-70" name="__codelineno-31-70"></a><span class="s2">You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-31-71"><a id="__codelineno-31-71" name="__codelineno-31-71"></a>
</span><span id="__span-31-72"><a id="__codelineno-31-72" name="__codelineno-31-72"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-31-73"><a id="__codelineno-31-73" name="__codelineno-31-73"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-31-74"><a id="__codelineno-31-74" name="__codelineno-31-74"></a>
</span><span id="__span-31-75"><a id="__codelineno-31-75" name="__codelineno-31-75"></a><span class="c1"># start everything</span>
</span><span id="__span-31-76"><a id="__codelineno-31-76" name="__codelineno-31-76"></a><span class="n">events</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-31-77"><a id="__codelineno-31-77" name="__codelineno-31-77"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">template</span> <span class="p">},</span>
</span><span id="__span-31-78"><a id="__codelineno-31-78" name="__codelineno-31-78"></a>    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
</span><span id="__span-31-79"><a id="__codelineno-31-79" name="__codelineno-31-79"></a>    <span class="n">stream_mode</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span>
</span><span id="__span-31-80"><a id="__codelineno-31-80" name="__codelineno-31-80"></a><span class="p">)</span>
</span><span id="__span-31-81"><a id="__codelineno-31-81" name="__codelineno-31-81"></a>
</span><span id="__span-31-82"><a id="__codelineno-31-82" name="__codelineno-31-82"></a><span class="c1"># output all occurring logs</span>
</span><span id="__span-31-83"><a id="__codelineno-31-83" name="__codelineno-31-83"></a><span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-31-84"><a id="__codelineno-31-84" name="__codelineno-31-84"></a>    <span class="n">print_event</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>And that's it! Enjoy your multi-agent driven plan-and-execute architecture!</p>
<h3 id="improvement-ideas"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#improvement-ideas">Improvement Ideas</a></h3>
<p>Before we move further with our exploration of offensive graphs,, we might want to investigate logging and tracing options. As we are now starting subgraphs (or might even run subgraphs/agents in-parallel), traditional console output becomes confusing to follow. Stay tuned!</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotation", "content.code.copy", "navigation.expand", "navigation.instant.preview", "navigation.path", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>